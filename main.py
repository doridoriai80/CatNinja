import pygame
import random
import config
import os
import json

pygame.init()

screen = pygame.display.set_mode((config.WIDTH, config.HEIGHT))
pygame.display.set_caption("ê°•ì•„ì§€ ë‹Œì íš¡ìŠ¤í¬ë¡¤")

clock = pygame.time.Clock()

# í•œê¸€ í°íŠ¸ ì„¤ì •
try:
    # macOSì—ì„œ ê¸°ë³¸ í•œê¸€ í°íŠ¸ ì‚¬ìš©
    font = pygame.font.SysFont("AppleGothic", 24)
    font_large = pygame.font.SysFont("AppleGothic", 36)
    font_title = pygame.font.SysFont("AppleGothic", 48)  # ê²Œì„ ì œëª©ìš© í° í°íŠ¸
    font_small = pygame.font.SysFont("AppleGothic", 18)
except:
    try:
        # Windowsì—ì„œ ê¸°ë³¸ í•œê¸€ í°íŠ¸ ì‚¬ìš©
        font = pygame.font.SysFont("malgun gothic", 24)
        font_large = pygame.font.SysFont("malgun gothic", 36)
        font_title = pygame.font.SysFont("malgun gothic", 48)  # ê²Œì„ ì œëª©ìš© í° í°íŠ¸
        font_small = pygame.font.SysFont("malgun gothic", 18)
    except:
        # í´ë°± í°íŠ¸
        font = pygame.font.SysFont("arial", 24)
        font_large = pygame.font.SysFont("arial", 36)
        font_title = pygame.font.SysFont("arial", 48)  # ê²Œì„ ì œëª©ìš© í° í°íŠ¸
        font_small = pygame.font.SysFont("arial", 18)

# --- í´ë˜ìŠ¤ë“¤ ---

# ============================================================================
# ğŸ• í”Œë ˆì´ì–´ í´ë˜ìŠ¤ (Player Class)
# ============================================================================
# í”Œë ˆì´ì–´ëŠ” ê²Œì„ì˜ ì£¼ì¸ê³µì¸ ê°•ì•„ì§€ ë‹Œìì…ë‹ˆë‹¤.
# ì´ í´ë˜ìŠ¤ëŠ” í”Œë ˆì´ì–´ì˜ ëª¨ë“  ë™ì‘ê³¼ ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

class Player(pygame.sprite.Sprite):
    """
    í”Œë ˆì´ì–´(ê°•ì•„ì§€ ë‹Œì) í´ë˜ìŠ¤
    
    ì£¼ìš” ê¸°ëŠ¥:
    - ì¢Œìš° ì´ë™ (â† â†’ í‚¤)
    - ì í”„ (ìŠ¤í˜ì´ìŠ¤ë°”)
    - ìˆ˜ë¦¬ê²€ ë°œì‚¬ (Z í‚¤)
    - puppy ë°©ì–´ íš¨ê³¼ ì‚¬ìš©
    - ê°„ì‹ íš¨ê³¼ (ë”ë¸” ìˆ˜ë¦¬ê²€)
    
    pygame.sprite.Spriteë¥¼ ìƒì†ë°›ì•„ Pygameì˜ ìŠ¤í”„ë¼ì´íŠ¸ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    """
    
    def __init__(self):
        """
        í”Œë ˆì´ì–´ ì´ˆê¸°í™” - í”Œë ˆì´ì–´ ê°ì²´ê°€ ìƒì„±ë  ë•Œ í•œ ë²ˆë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - í”Œë ˆì´ì–´ì˜ ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ê³  í¬ê¸°ë¥¼ ì¡°ì •í•©ë‹ˆë‹¤
        - í”Œë ˆì´ì–´ì˜ ì´ˆê¸° ìœ„ì¹˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        - í”Œë ˆì´ì–´ì˜ ë¬¼ë¦¬ ì†ì„±(ì†ë„, ì¤‘ë ¥ ë“±)ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤
        - ê²Œì„ ìƒíƒœ ë³€ìˆ˜ë“¤ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤
        """
        super().__init__()  # pygame.sprite.Sprite ì´ˆê¸°í™” (ë°˜ë“œì‹œ í•„ìš”)
        
        # ===== ì´ë¯¸ì§€ ë¡œë“œ ë° ì„¤ì • =====
        try:
            # assets/player.png íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ í”Œë ˆì´ì–´ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©
            # convert_alpha()ëŠ” íˆ¬ëª…ë„ë¥¼ ì§€ì›í•˜ëŠ” ì´ë¯¸ì§€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤
            self.original_image = pygame.image.load("assets/player.png").convert_alpha()
            
            # config.pyì— ì •ì˜ëœ í¬ê¸°ë¡œ ì´ë¯¸ì§€ ì¡°ì •
            # transform.scale(ì´ë¯¸ì§€, (ë„ˆë¹„, ë†’ì´))ë¡œ í¬ê¸°ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤
            self.image = pygame.transform.scale(self.original_image, (config.PLAYER_WIDTH, config.PLAYER_HEIGHT))
        except:
            # ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì‚¬ê°í˜•ìœ¼ë¡œ ëŒ€ì²´
            # Surface(ë„ˆë¹„, ë†’ì´)ë¡œ ë¹ˆ ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ê³  fill(ìƒ‰ìƒ)ë¡œ ì±„ì›ë‹ˆë‹¤
            self.image = pygame.Surface((config.PLAYER_WIDTH, config.PLAYER_HEIGHT))
            self.image.fill((200, 150, 100))  # ê°ˆìƒ‰ ì‚¬ê°í˜•
            print("âš ï¸ í”Œë ˆì´ì–´ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ - ê¸°ë³¸ ì‚¬ê°í˜• ì‚¬ìš©")
        
        # ===== ì¶©ëŒ ì˜ì—­ ì„¤ì • =====
        # rectëŠ” í”Œë ˆì´ì–´ì˜ ì¶©ëŒ ì˜ì—­ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤
        # get_rect()ë¡œ ì´ë¯¸ì§€ í¬ê¸°ì— ë§ëŠ” ì‚¬ê°í˜•ì„ ìƒì„±í•©ë‹ˆë‹¤
        self.rect = self.image.get_rect()
        
        # í”Œë ˆì´ì–´ì˜ ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •
        # bottomleftëŠ” ì‚¬ê°í˜•ì˜ ì™¼ìª½ í•˜ë‹¨ ëª¨ì„œë¦¬ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤
        # (50, config.HEIGHT - 50)ì€ í™”ë©´ ì™¼ìª½ í•˜ë‹¨ì—ì„œ ì•½ê°„ ë–¨ì–´ì§„ ìœ„ì¹˜ì…ë‹ˆë‹¤
        self.rect.bottomleft = (50, config.HEIGHT - 50)
        
        # ===== ë¬¼ë¦¬ ì†ì„± ì´ˆê¸°í™” =====
        self.vel_y = 0        # Yì¶• ì†ë„ (ì í”„, ë‚™í•˜í•  ë•Œ ì‚¬ìš©)
        self.speed = config.PLAYER_SPEED  # ì¢Œìš° ì´ë™ ì†ë„ (config.pyì—ì„œ ê°€ì ¸ì˜´)
        self.on_ground = True # ì§€ë©´ ì ‘ì´‰ ì—¬ë¶€ (ì í”„ ê°€ëŠ¥ ì—¬ë¶€ íŒë‹¨ìš©)
        
        # ===== ê²Œì„ ìƒíƒœ ë³€ìˆ˜ ì´ˆê¸°í™” =====
        self.alive = True           # ìƒì¡´ ì—¬ë¶€ (True = ì‚´ì•„ìˆìŒ, False = ì£½ìŒ)
        self.shuriken_double = False # ë”ë¸” ìˆ˜ë¦¬ê²€ íš¨ê³¼ í™œì„±í™” ì—¬ë¶€
        self.double_end_time = 0    # ë”ë¸” ìˆ˜ë¦¬ê²€ íš¨ê³¼ ì¢…ë£Œ ì‹œê°„
        
        # ===== puppy ë°©ì–´ ì‹œìŠ¤í…œ ë³€ìˆ˜ =====
        self.defense_count = 0      # ë‚¨ì€ ë°©ì–´ íšŸìˆ˜ (0 = ë°©ì–´ ë¶ˆê°€, 1 ì´ìƒ = ë°©ì–´ ê°€ëŠ¥)
        self.defense_active = False # ë°©ì–´ íš¨ê³¼ í™œì„±í™” ì—¬ë¶€

    def update(self, keys):
        """
        í”Œë ˆì´ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸ - ë§¤ í”„ë ˆì„ë§ˆë‹¤ í˜¸ì¶œë©ë‹ˆë‹¤.
        
        Args:
            keys: pygame.key.get_pressed()ë¡œ ì–»ì€ í‚¤ ì…ë ¥ ìƒíƒœ
                  í‚¤ë¥¼ ëˆ„ë¥´ê³  ìˆìœ¼ë©´ True, ëˆ„ë¥´ì§€ ì•Šìœ¼ë©´ False
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - í‚¤ ì…ë ¥ì— ë”°ë¥¸ í”Œë ˆì´ì–´ ì´ë™ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤
        - ì í”„ì™€ ë‚™í•˜ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤
        - í™”ë©´ ê²½ê³„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì œí•œí•©ë‹ˆë‹¤
        - ë”ë¸” ìˆ˜ë¦¬ê²€ íš¨ê³¼ ì‹œê°„ì„ ì²´í¬í•©ë‹ˆë‹¤
        """
        # í”Œë ˆì´ì–´ê°€ ì£½ì–´ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
        if not self.alive:
            return
        
        # ===== ì¢Œìš° ì´ë™ ì²˜ë¦¬ =====
        if keys[pygame.K_LEFT]:  # ì™¼ìª½ í™”ì‚´í‘œ í‚¤ë¥¼ ëˆ„ë¥´ê³  ìˆìœ¼ë©´
            self.rect.x -= self.speed  # ì™¼ìª½ìœ¼ë¡œ ì´ë™ (Xì¢Œí‘œ ê°ì†Œ)
            # í™”ë©´ ì™¼ìª½ ê²½ê³„ ì²´í¬ - í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì œí•œ
            if self.rect.left < 0:
                self.rect.left = 0  # ì™¼ìª½ ê²½ê³„ì— ê³ ì •
                
        if keys[pygame.K_RIGHT]:  # ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ í‚¤ë¥¼ ëˆ„ë¥´ê³  ìˆìœ¼ë©´
            self.rect.x += self.speed  # ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ (Xì¢Œí‘œ ì¦ê°€)
            # í™”ë©´ ì˜¤ë¥¸ìª½ ê²½ê³„ ì²´í¬ - í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì œí•œ
            if self.rect.right > config.WIDTH:
                self.rect.right = config.WIDTH  # ì˜¤ë¥¸ìª½ ê²½ê³„ì— ê³ ì •

        # ===== ì í”„ ì²˜ë¦¬ =====
        if keys[pygame.K_UP] and self.on_ground:  # ìœ„ìª½ í™”ì‚´í‘œ + ì§€ë©´ ì ‘ì´‰ ì‹œ
            self.vel_y = config.PLAYER_JUMP_VELOCITY  # ì í”„ ì†ë„ ì„¤ì • (ìŒìˆ˜ = ìœ„ë¡œ)
            self.on_ground = False  # ì í”„ ì¤‘ì´ë¯€ë¡œ ì§€ë©´ì—ì„œ ë–¨ì–´ì§

        # ===== ì¤‘ë ¥ ì ìš© =====
        self.vel_y += config.GRAVITY  # ì¤‘ë ¥ìœ¼ë¡œ ì¸í•´ ì•„ë˜ë¡œ ê°€ì†
        self.rect.y += self.vel_y     # Yì¶• ìœ„ì¹˜ ì—…ë°ì´íŠ¸

        # ===== ì§€ë©´ ì²˜ë¦¬ =====
        if self.rect.bottom >= config.HEIGHT - 50:  # ë°”ë‹¥ì— ë‹¿ìœ¼ë©´
            self.rect.bottom = config.HEIGHT - 50   # ë°”ë‹¥ì— ê³ ì •
            self.vel_y = 0                          # ë‚™í•˜ ì†ë„ ì´ˆê¸°í™”
            self.on_ground = True                   # ì§€ë©´ ì ‘ì´‰ ìƒíƒœë¡œ ë³€ê²½

        # ===== ë”ë¸” ìˆ˜ë¦¬ê²€ íš¨ê³¼ ì‹œê°„ ì²´í¬ =====
        if self.shuriken_double and pygame.time.get_ticks() > self.double_end_time:
            # íš¨ê³¼ ì‹œê°„ì´ ì§€ë‚˜ë©´ ë”ë¸” ìˆ˜ë¦¬ê²€ íš¨ê³¼ ë¹„í™œì„±í™”
            self.shuriken_double = False

    def eat_snack(self):
        """
        ê°„ì‹ì„ ë¨¹ì—ˆì„ ë•Œ ë”ë¸” ìˆ˜ë¦¬ê²€ íš¨ê³¼ë¥¼ í™œì„±í™”í•©ë‹ˆë‹¤.
        
        ì´ ë©”ì„œë“œëŠ” ê°„ì‹ê³¼ ì¶©ëŒí–ˆì„ ë•Œ ìë™ìœ¼ë¡œ í˜¸ì¶œë©ë‹ˆë‹¤.
        """
        self.shuriken_double = True  # ë”ë¸” ìˆ˜ë¦¬ê²€ íš¨ê³¼ í™œì„±í™”
        # í˜„ì¬ ì‹œê°„ + ì§€ì† ì‹œê°„ìœ¼ë¡œ íš¨ê³¼ ì¢…ë£Œ ì‹œê°„ ê³„ì‚°
        self.double_end_time = pygame.time.get_ticks() + config.SNACK_DURATION

    def get_puppy(self):
        """
        puppy ì•„ì´í…œì„ íšë“í•˜ì—¬ ë°©ì–´ íš¨ê³¼ë¥¼ í™œì„±í™”í•©ë‹ˆë‹¤.
        
        Returns:
            bool: puppy íšë“ ì„±ê³µ ì—¬ë¶€
                  True = íšë“ ì„±ê³µ, False = ì´ë¯¸ ë³´ìœ  ì¤‘
        
        ì´ ë©”ì„œë“œëŠ” puppyì™€ ì¶©ëŒí–ˆì„ ë•Œ ìë™ìœ¼ë¡œ í˜¸ì¶œë©ë‹ˆë‹¤.
        """
        print(f"get_puppy í˜¸ì¶œ: í˜„ì¬ defense_count={self.defense_count}")
        
        if self.defense_count == 0:  # puppyê°€ ì—†ì„ ë•Œë§Œ íšë“ ê°€ëŠ¥
            self.defense_count = config.PUPPY_DEFENSE_COUNT  # configì—ì„œ ë°©ì–´ íšŸìˆ˜ ê°€ì ¸ì˜¤ê¸°
            self.defense_active = True  # ë°©ì–´ íš¨ê³¼ í™œì„±í™”
            print(f"puppy íšë“ ì„±ê³µ: defense_count={self.defense_count}")
            return True  # puppy íšë“ ì„±ê³µ
            
        print(f"ì´ë¯¸ puppy ë³´ìœ  ì¤‘: defense_count={self.defense_count}")
        return False  # ì´ë¯¸ puppyë¥¼ ê°€ì§€ê³  ìˆìŒ

    def use_defense(self):
        """
        ë°©ì–´ íš¨ê³¼ ì‚¬ìš© (ì¶©ëŒ ì‹œ ìë™ í˜¸ì¶œ) - í˜„ì¬ëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŒ
        
        Returns:
            bool: ë°©ì–´ íš¨ê³¼ ì‚¬ìš© ì„±ê³µ ì—¬ë¶€
                  True = ë°©ì–´ ì„±ê³µ, False = ë°©ì–´ ì‹¤íŒ¨
        
        ì´ ë©”ì„œë“œëŠ” ì´ì „ ë²„ì „ì—ì„œ ì‚¬ìš©ë˜ì—ˆì§€ë§Œ, í˜„ì¬ëŠ” remove_puppy_defense()ë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤.
        """
        if self.defense_count > 0:
            self.defense_count -= 1  # ë°©ì–´ íšŸìˆ˜ 1íšŒ ê°ì†Œ
            if self.defense_count <= 0:
                self.defense_active = False  # ë°©ì–´ íšŸìˆ˜ê°€ 0ì´ ë˜ë©´ ë¹„í™œì„±í™”
            return True  # ë°©ì–´ ì„±ê³µ
        return False  # ë°©ì–´ ì‹¤íŒ¨

    def has_defense(self):
        """
        í˜„ì¬ ë°©ì–´ íš¨ê³¼ ë³´ìœ  ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
        
        Returns:
            bool: ë°©ì–´ íš¨ê³¼ ë³´ìœ  ì—¬ë¶€
                  True = ë°©ì–´ íš¨ê³¼ ìˆìŒ, False = ë°©ì–´ íš¨ê³¼ ì—†ìŒ
        
        ì´ ë©”ì„œë“œëŠ” ì¶©ëŒ ê°ì§€ ì‹œ í”Œë ˆì´ì–´ê°€ ë°©ì–´ íš¨ê³¼ë¥¼ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
        """
        has_defense = self.defense_count > 0
        print(f"has_defense í˜¸ì¶œ: defense_count={self.defense_count}, has_defense={has_defense}")
        return has_defense

    def remove_puppy_defense(self):
        """
        puppy ë°©ì–´ íš¨ê³¼ë¥¼ ì†Œëª¨í•©ë‹ˆë‹¤ (ì¶©ëŒ ì‹œ ìë™ í˜¸ì¶œ).
        
        Returns:
            bool: ë°©ì–´ íš¨ê³¼ ì†Œëª¨ ì„±ê³µ ì—¬ë¶€
                  True = ì†Œëª¨ ì„±ê³µ, False = ì†Œëª¨ ì‹¤íŒ¨
        
        ì´ ë©”ì„œë“œëŠ” í”Œë ˆì´ì–´ê°€ ì ì´ë‚˜ ëŒê³¼ ì¶©ëŒí–ˆì„ ë•Œ ìë™ìœ¼ë¡œ í˜¸ì¶œë©ë‹ˆë‹¤.
        ë°©ì–´ íšŸìˆ˜ê°€ 1íšŒ ê°ì†Œí•˜ê³ , 0ì´ ë˜ë©´ ë°©ì–´ íš¨ê³¼ê°€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.
        """
        if self.defense_count > 0:
            self.defense_count -= 1  # ë°©ì–´ íšŸìˆ˜ 1íšŒ ê°ì†Œ
            if self.defense_count <= 0:
                self.defense_active = False  # ë°©ì–´ íšŸìˆ˜ê°€ 0ì´ ë˜ë©´ ë¹„í™œì„±í™”
                print(f"ğŸ• puppy ë°©ì–´ íš¨ê³¼ ì™„ì „ ì†Œëª¨ë¨")
            else:
                print(f"ğŸ• puppy ë°©ì–´ íš¨ê³¼ 1íšŒ ì†Œëª¨, ë‚¨ì€ íšŸìˆ˜: {self.defense_count}")
            return True
        return False

    def draw_puppy(self, screen):
        """
        í”Œë ˆì´ì–´ ì˜¤ë¥¸ìª½ì— puppyë¥¼ í‘œì‹œí•©ë‹ˆë‹¤ (ë°©ì–´ íš¨ê³¼ í™œì„±í™” ì‹œ).
        
        Args:
            screen: pygame í™”ë©´ ê°ì²´ (ê·¸ë¦¬ê¸° ëŒ€ìƒ)
        
        ì´ ë©”ì„œë“œëŠ” í”Œë ˆì´ì–´ê°€ puppy ë°©ì–´ íš¨ê³¼ë¥¼ ê°€ì§€ê³  ìˆì„ ë•Œë§Œ í˜¸ì¶œë©ë‹ˆë‹¤.
        puppy ì´ë¯¸ì§€ë¥¼ í”Œë ˆì´ì–´ ì˜¤ë¥¸ìª½ì— ì‘ì€ í¬ê¸°ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
        """
        if self.defense_count > 0:  # puppyê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ
            try:
                # puppy ì´ë¯¸ì§€ ë¡œë“œ (ì›ë³¸ ì´ë¯¸ì§€, ì¢Œìš° ë°˜ì „ ì—†ìŒ)
                puppy_image = pygame.image.load("assets/puppy.png").convert_alpha()
                
                # ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • (í”Œë ˆì´ì–´ë³´ë‹¤ ì‘ê²Œ)
                puppy_size = config.PUPPY_DISPLAY_SIZE
                puppy_image = pygame.transform.scale(puppy_image, (puppy_size, puppy_size))
                
                # í”Œë ˆì´ì–´ ì˜¤ë¥¸ìª½ì— í‘œì‹œí•  ìœ„ì¹˜ ê³„ì‚°
                puppy_x = self.rect.right + 10  # í”Œë ˆì´ì–´ ì˜¤ë¥¸ìª½ì—ì„œ 10í”½ì…€ ë–¨ì–´ì§„ ìœ„ì¹˜
                puppy_y = self.rect.centery     # í”Œë ˆì´ì–´ ì¤‘ì•™ ë†’ì´
                
                # puppy ì´ë¯¸ì§€ë¥¼ í™”ë©´ì— ê·¸ë¦¬ê¸°
                # blit(ì´ë¯¸ì§€, (x, y))ë¡œ ì´ë¯¸ì§€ë¥¼ ì§€ì •ëœ ìœ„ì¹˜ì— ê·¸ë¦½ë‹ˆë‹¤
                # puppy_size//2ë¥¼ ë¹¼ëŠ” ì´ìœ ëŠ” ì´ë¯¸ì§€ì˜ ì¤‘ì‹¬ì„ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ë§ì¶”ê¸° ìœ„í•¨ì…ë‹ˆë‹¤
                screen.blit(puppy_image, (puppy_x - puppy_size//2, puppy_y - puppy_size//2))
                
            except:
                # ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì£¼í™©ìƒ‰ ì›ìœ¼ë¡œ ëŒ€ì²´
                puppy_x = self.rect.right + 10
                puppy_y = self.rect.centery
                # draw_circle(í™”ë©´, ìƒ‰ìƒ, (x, y), ë°˜ì§€ë¦„)ìœ¼ë¡œ ì›ì„ ê·¸ë¦½ë‹ˆë‹¤
                pygame.draw.circle(screen, (255, 200, 100), (puppy_x, puppy_y), config.PUPPY_DISPLAY_SIZE//2)


# ============================================================================
# ğŸ¥· ìˆ˜ë¦¬ê²€ í´ë˜ìŠ¤ (Shuriken Class)
# ============================================================================
# ìˆ˜ë¦¬ê²€ì€ í”Œë ˆì´ì–´ê°€ ë°œì‚¬í•˜ëŠ” ë¬´ê¸°ì…ë‹ˆë‹¤.
# Z í‚¤ë¥¼ ëˆ„ë¥´ë©´ ë°œì‚¬ë˜ë©°, ì ì„ ê³µê²©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

class Shuriken(pygame.sprite.Sprite):
    """
    ìˆ˜ë¦¬ê²€ í´ë˜ìŠ¤
    
    ì£¼ìš” ê¸°ëŠ¥:
    - í”Œë ˆì´ì–´ê°€ ë°œì‚¬í•˜ëŠ” íˆ¬ì²™ ë¬´ê¸°
    - ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì§ì„  ì´ë™
    - ì ê³¼ ì¶©ëŒ ì‹œ ë°ë¯¸ì§€
    - í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ ì œê±°
    
    pygame.sprite.Spriteë¥¼ ìƒì†ë°›ì•„ Pygameì˜ ìŠ¤í”„ë¼ì´íŠ¸ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    """
    
    def __init__(self, x, y):
        """
        ìˆ˜ë¦¬ê²€ ì´ˆê¸°í™” - ìˆ˜ë¦¬ê²€ ê°ì²´ê°€ ìƒì„±ë  ë•Œ í•œ ë²ˆë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
        
        Args:
            x: ìˆ˜ë¦¬ê²€ ì‹œì‘ X ì¢Œí‘œ (ë³´í†µ í”Œë ˆì´ì–´ì˜ ì˜¤ë¥¸ìª½ ìœ„ì¹˜)
            y: ìˆ˜ë¦¬ê²€ ì‹œì‘ Y ì¢Œí‘œ (ë³´í†µ í”Œë ˆì´ì–´ì˜ ì¤‘ì•™ ë†’ì´)
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - ìˆ˜ë¦¬ê²€ì˜ ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ê³  í¬ê¸°ë¥¼ ì¡°ì •í•©ë‹ˆë‹¤
        - ìˆ˜ë¦¬ê²€ì˜ ì´ˆê¸° ìœ„ì¹˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        - ìˆ˜ë¦¬ê²€ì˜ ì´ë™ ì†ë„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        """
        super().__init__()  # pygame.sprite.Sprite ì´ˆê¸°í™” (ë°˜ë“œì‹œ í•„ìš”)
        
        # ===== ì´ë¯¸ì§€ ë¡œë“œ ë° ì„¤ì • =====
        try:
            # assets/shuriken.png íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ ìˆ˜ë¦¬ê²€ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©
            # convert_alpha()ëŠ” íˆ¬ëª…ë„ë¥¼ ì§€ì›í•˜ëŠ” ì´ë¯¸ì§€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤
            self.original_image = pygame.image.load("assets/shuriken.png").convert_alpha()
            
            # config.pyì— ì •ì˜ëœ í¬ê¸°ë¡œ ì´ë¯¸ì§€ ì¡°ì •
            # transform.scale(ì´ë¯¸ì§€, (ë„ˆë¹„, ë†’ì´))ë¡œ í¬ê¸°ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤
            self.image = pygame.transform.scale(self.original_image, (config.SHURIKEN_WIDTH, config.SHURIKEN_HEIGHT))
        except:
            # ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê²€ì€ìƒ‰ ì‚¬ê°í˜•ìœ¼ë¡œ ëŒ€ì²´
            # Surface(ë„ˆë¹„, ë†’ì´)ë¡œ ë¹ˆ ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ê³  fill(ìƒ‰ìƒ)ë¡œ ì±„ì›ë‹ˆë‹¤
            self.image = pygame.Surface((config.SHURIKEN_WIDTH, config.SHURIKEN_HEIGHT))
            self.image.fill(config.BLACK)  # ê²€ì€ìƒ‰ ì‚¬ê°í˜•
            print("âš ï¸ ìˆ˜ë¦¬ê²€ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ - ê¸°ë³¸ ì‚¬ê°í˜• ì‚¬ìš©")
        
        # ===== ì¶©ëŒ ì˜ì—­ ì„¤ì • =====
        # rectëŠ” ìˆ˜ë¦¬ê²€ì˜ ì¶©ëŒ ì˜ì—­ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤
        # get_rect(center=(x, y))ë¡œ ì´ë¯¸ì§€ ì¤‘ì‹¬ì„ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ê°í˜•ì„ ìƒì„±í•©ë‹ˆë‹¤
        self.rect = self.image.get_rect(center=(x, y))
        
        # ===== ì´ë™ ì†ë„ ì„¤ì • =====
        # ìˆ˜ë¦¬ê²€ ì´ë™ ì†ë„ (config.pyì—ì„œ ê°€ì ¸ì˜´)
        # ì–‘ìˆ˜ ê°’ì´ë¯€ë¡œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤
        self.speed = config.SHURIKEN_SPEED
    
    def update(self, keys=None):
        """
        ìˆ˜ë¦¬ê²€ ìƒíƒœ ì—…ë°ì´íŠ¸ - ë§¤ í”„ë ˆì„ë§ˆë‹¤ í˜¸ì¶œë©ë‹ˆë‹¤.
        
        Args:
            keys: í‚¤ ì…ë ¥ (ìˆ˜ë¦¬ê²€ì€ ìë™ ì´ë™í•˜ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - ìˆ˜ë¦¬ê²€ì„ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
        - í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ìœ¼ë¡œ ì œê±°í•©ë‹ˆë‹¤
        """
        # ===== ìˆ˜ë¦¬ê²€ ì´ë™ =====
        # ìˆ˜ë¦¬ê²€ì„ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ (Xì¢Œí‘œ ì¦ê°€)
        self.rect.x += self.speed
        
        # ===== í™”ë©´ ê²½ê³„ ì²´í¬ =====
        # í™”ë©´ ì™¼ìª½ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ ì œê±° (ë©”ëª¨ë¦¬ ì ˆì•½)
        # í™”ë©´ ì™¼ìª½ ê²½ê³„ëŠ” 0ë³´ë‹¤ ì‘ì€ ê°’ì…ë‹ˆë‹¤
        if self.rect.left > config.WIDTH:
            self.kill()  # ìŠ¤í”„ë¼ì´íŠ¸ë¥¼ ì œê±°í•˜ê³  ë©”ëª¨ë¦¬ì—ì„œ í•´ì œ

# ============================================================================
# ğŸ± ì  ê³ ì–‘ì´ í´ë˜ìŠ¤ (EnemyCat Class)
# ============================================================================
# ì  ê³ ì–‘ì´ëŠ” í”Œë ˆì´ì–´ë¥¼ ê³µê²©í•˜ëŠ” ì ì…ë‹ˆë‹¤.
# ë…¸ë€ìƒ‰, ê²€ì€ìƒ‰, í°ìƒ‰ì˜ ì„¸ ê°€ì§€ íƒ€ì…ì´ ìˆìœ¼ë©°, ê°ê° ë‹¤ë¥¸ íŠ¹ì„±ì„ ê°€ì§‘ë‹ˆë‹¤.

class EnemyCat(pygame.sprite.Sprite):
    """
    ì  ê³ ì–‘ì´ í´ë˜ìŠ¤
    
    ê³ ì–‘ì´ íƒ€ì…ë³„ íŠ¹ì„±:
    - ë…¸ë€ìƒ‰: ê¸°ë³¸ ê³ ì–‘ì´ (ë³´í†µ ì²´ë ¥, ë³´í†µ ì†ë„)
    - ê²€ì€ìƒ‰: ê°•í•œ ê³ ì–‘ì´ (ë†’ì€ ì²´ë ¥, ëŠë¦° ì†ë„)
    - í°ìƒ‰: ë¹ ë¥¸ ê³ ì–‘ì´ (ë‚®ì€ ì²´ë ¥, ë¹ ë¥¸ ì†ë„, ì í”„ ëŠ¥ë ¥)
    
    ì£¼ìš” ê¸°ëŠ¥:
    - ì™¼ìª½ìœ¼ë¡œ ìë™ ì´ë™
    - í”Œë ˆì´ì–´ì™€ ì¶©ëŒ ì‹œ ê²Œì„ì˜¤ë²„
    - ìˆ˜ë¦¬ê²€ì— ë§ìœ¼ë©´ ì²´ë ¥ ê°ì†Œ
    - í°ìƒ‰ ê³ ì–‘ì´ëŠ” ì í”„í•˜ë©´ì„œ ì´ë™
    
    pygame.sprite.Spriteë¥¼ ìƒì†ë°›ì•„ Pygameì˜ ìŠ¤í”„ë¼ì´íŠ¸ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    """
    
    def __init__(self, x, y, color_name, stage=1):
        """
        ì  ê³ ì–‘ì´ ì´ˆê¸°í™” - ê³ ì–‘ì´ ê°ì²´ê°€ ìƒì„±ë  ë•Œ í•œ ë²ˆë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
        
        Args:
            x: ê³ ì–‘ì´ ì‹œì‘ X ì¢Œí‘œ (ë³´í†µ í™”ë©´ ì˜¤ë¥¸ìª½ì—ì„œ ì‹œì‘)
            y: ê³ ì–‘ì´ ì‹œì‘ Y ì¢Œí‘œ (ë³´í†µ ì§€ë©´ ë†’ì´)
            color_name: ê³ ì–‘ì´ ìƒ‰ìƒ ("yellow", "black", "white")
            stage: í˜„ì¬ ìŠ¤í…Œì´ì§€ (ì²´ë ¥ ê³„ì‚°ì— ì‚¬ìš©, ê¸°ë³¸ê°’: 1)
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - ê³ ì–‘ì´ì˜ ìƒ‰ìƒê³¼ ì²´ë ¥ì„ ì„¤ì •í•©ë‹ˆë‹¤
        - ê³ ì–‘ì´ì˜ í¬ê¸°ì™€ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        - ê³ ì–‘ì´ì˜ ì´ë™ ì†ë„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        - ì í”„ ê´€ë ¨ ë³€ìˆ˜ë“¤ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤ (í°ìƒ‰ ê³ ì–‘ì´ìš©)
        """
        super().__init__()  # pygame.sprite.Sprite ì´ˆê¸°í™” (ë°˜ë“œì‹œ í•„ìš”)
        
        # ===== ê³ ì–‘ì´ ì†ì„± ì„¤ì • =====
        self.color_name = color_name  # ìƒ‰ìƒ ì´ë¦„ ì €ì¥ (ì˜ˆ: "yellow", "black", "white")
        self.color = self.get_color(color_name)  # ì‹¤ì œ ìƒ‰ìƒ ê°’ ê°€ì ¸ì˜¤ê¸° (RGB)
        self.hp = self.get_hp(color_name, stage)  # ì²´ë ¥ ì„¤ì • (ìŠ¤í…Œì´ì§€ì— ë”°ë¼ ì¦ê°€)
        
        # ===== ê³ ì–‘ì´ í¬ê¸° ì„¤ì • =====
        # ìƒ‰ìƒë³„ë¡œ ë‹¤ë¥¸ í¬ê¸° ì„¤ì • (config.pyì—ì„œ ê°€ì ¸ì˜´)
        self.width, self.height = config.ENEMY_CAT_SIZE[color_name]
        
        # ===== ì í”„ ê´€ë ¨ ë³€ìˆ˜ (í°ìƒ‰ ê³ ì–‘ì´ìš©) =====
        self.vel_y = 0        # Yì¶• ì†ë„ (ì í”„, ë‚™í•˜í•  ë•Œ ì‚¬ìš©)
        self.on_ground = False # ì§€ë©´ ì ‘ì´‰ ì—¬ë¶€ (ì í”„ ê°€ëŠ¥ ì—¬ë¶€ íŒë‹¨ìš©)
        self.jump_timer = 0   # ì í”„ íƒ€ì´ë¨¸ (ì í”„ ê°„ê²© ì¡°ì ˆìš©)
        self.jump_interval = config.WHITE_CAT_JUMP_INTERVAL  # ì í”„ ê°„ê²© (configì—ì„œ ê°€ì ¸ì˜´)
        
        # ===== ê³ ì–‘ì´ ì´ë¯¸ì§€ ë¡œë“œ ë° í¬ê¸° ì¡°ì • =====
        try:
            # assets/ í´ë”ì—ì„œ í•´ë‹¹ ìƒ‰ìƒì˜ ê³ ì–‘ì´ ì´ë¯¸ì§€ ë¡œë“œ
            # f-stringì„ ì‚¬ìš©í•˜ì—¬ ë™ì ìœ¼ë¡œ íŒŒì¼ ê²½ë¡œ ìƒì„±
            image_path = f"assets/cat_{color_name}.png"
            self.original_image = pygame.image.load(image_path).convert_alpha()
            
            # config.pyì— ì •ì˜ëœ í¬ê¸°ë¡œ ì´ë¯¸ì§€ ì¡°ì •
            self.image = pygame.transform.scale(self.original_image, (self.width, self.height))
            
            # ê³ ì–‘ì´ê°€ ì™¼ìª½ìœ¼ë¡œ ì´ë™í•˜ë¯€ë¡œ ì´ë¯¸ì§€ë¥¼ ì¢Œìš° ë°˜ì „
            self.image = pygame.transform.flip(self.image, True, False)
        except:
            # ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìƒ‰ìƒ ì‚¬ê°í˜•ìœ¼ë¡œ ëŒ€ì²´
            self.image = pygame.Surface((self.width, self.height))
            self.image.fill(self.color)  # ê³ ì–‘ì´ ìƒ‰ìƒìœ¼ë¡œ ì±„ì›€
            print(f"âš ï¸ {color_name} ê³ ì–‘ì´ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ - ê¸°ë³¸ ì‚¬ê°í˜• ì‚¬ìš©")
        
        # ===== ê³ ì–‘ì´ì˜ ì¶©ëŒ ì˜ì—­ ì„¤ì • =====
        # rectëŠ” ê³ ì–‘ì´ì˜ ì¶©ëŒ ì˜ì—­ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤
        # midbottom=(x, y)ëŠ” ì‚¬ê°í˜•ì˜ í•˜ë‹¨ ì¤‘ì•™ì„ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        self.rect = self.image.get_rect(midbottom=(x, y))
        
        # ===== ê³ ì–‘ì´ ì´ë™ ì†ë„ ì„¤ì • =====
        # ìƒ‰ìƒë³„ë¡œ ë‹¤ë¥¸ ì´ë™ ì†ë„ (config.pyì—ì„œ ê°€ì ¸ì˜´)
        self.speed = config.ENEMY_CAT_SPEED[color_name]
    
    def get_color(self, color_name):
        """
        ìƒ‰ìƒ ì´ë¦„ì— ë”°ë¥¸ ì‹¤ì œ ìƒ‰ìƒ ê°’(RGB)ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
        
        Args:
            color_name: ìƒ‰ìƒ ì´ë¦„ ("yellow", "black", "white")
            
        Returns:
            tuple: RGB ìƒ‰ìƒ ê°’ (ì˜ˆ: (255, 255, 0) = ë…¸ë€ìƒ‰)
        """
        # ìƒ‰ìƒ ì´ë¦„ê³¼ ì‹¤ì œ ìƒ‰ìƒ ê°’ì„ ë§¤í•‘í•˜ëŠ” ë”•ì…”ë„ˆë¦¬
        color_map = {
            "yellow": config.YELLOW,  # ë…¸ë€ìƒ‰ (255, 255, 0)
            "black": config.BLACK,    # ê²€ì€ìƒ‰ (0, 0, 0)
            "white": config.WHITE     # í°ìƒ‰ (255, 255, 255)
        }
        # get() ë©”ì„œë“œë¡œ ìƒ‰ìƒì„ ê°€ì ¸ì˜¤ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ê°’(í°ìƒ‰) ë°˜í™˜
        return color_map.get(color_name, config.WHITE)
    
    def get_hp(self, color_name, stage):
        """
        ìƒ‰ìƒê³¼ ìŠ¤í…Œì´ì§€ì— ë”°ë¥¸ ì²´ë ¥ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
        
        Args:
            color_name: ìƒ‰ìƒ ì´ë¦„ ("yellow", "black", "white")
            stage: í˜„ì¬ ìŠ¤í…Œì´ì§€ (1ë¶€í„° ì‹œì‘)
            
        Returns:
            int: ê³„ì‚°ëœ ì²´ë ¥ ê°’
            
        ì²´ë ¥ ê³„ì‚° ê³µì‹:
        - ê¸°ë³¸ ì²´ë ¥ì€ ìƒ‰ìƒë³„ë¡œ ë‹¤ë¦„ (config.pyì—ì„œ ì„¤ì •)
        - ìŠ¤í…Œì´ì§€ê°€ ì˜¬ë¼ê°ˆìˆ˜ë¡ ì²´ë ¥ì´ ì¦ê°€ (ë‚œì´ë„ ì¡°ì ˆ)
        """
        # config.pyì—ì„œ ê¸°ë³¸ ì²´ë ¥ ê°€ì ¸ì˜¤ê¸°
        base_hp = config.ENEMY_CAT_BASE_HP.get(color_name, 1)
        
        # ìŠ¤í…Œì´ì§€ê°€ ì˜¬ë¼ê°ˆìˆ˜ë¡ ì²´ë ¥ ì¦ê°€ (ë‚œì´ë„ ì¡°ì ˆ)
        # stage_multiplier = 1 + (stage - 1) * config.ENEMY_CAT_STAGE_MULTIPLIER
        # ì˜ˆ: ìŠ¤í…Œì´ì§€ 1 = 1.0, ìŠ¤í…Œì´ì§€ 2 = 1.5, ìŠ¤í…Œì´ì§€ 3 = 2.0
        stage_multiplier = 1 + (stage - 1) * config.ENEMY_CAT_STAGE_MULTIPLIER
        
        # ê¸°ë³¸ ì²´ë ¥ Ã— ìŠ¤í…Œì´ì§€ ë°°ìœ¨ë¡œ ìµœì¢… ì²´ë ¥ ê³„ì‚°
        return int(base_hp * stage_multiplier)
    
    def update(self, keys=None):
        """
        ì  ê³ ì–‘ì´ ìƒíƒœ ì—…ë°ì´íŠ¸ - ë§¤ í”„ë ˆì„ë§ˆë‹¤ í˜¸ì¶œë©ë‹ˆë‹¤.
        
        Args:
            keys: í‚¤ ì…ë ¥ (ì ì€ ìë™ ë™ì‘í•˜ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - í°ìƒ‰ ê³ ì–‘ì´ì˜ ì í”„ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤
        - ê³ ì–‘ì´ë¥¼ ì™¼ìª½ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
        - í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ìœ¼ë¡œ ì œê±°í•©ë‹ˆë‹¤
        """
        # ===== í°ìƒ‰ ê³ ì–‘ì´ ì í”„ ë¡œì§ =====
        if self.color_name == "white":  # í°ìƒ‰ ê³ ì–‘ì´ì¼ ë•Œë§Œ ì í”„
            # ì í”„ íƒ€ì´ë¨¸ ì¦ê°€ (ì•½ 60FPS ê¸°ì¤€ìœ¼ë¡œ 16msì”© ì¦ê°€)
            self.jump_timer += 16
            
            # ì í”„ ê°„ê²©ì— ë„ë‹¬í•˜ë©´ ì í”„
            if self.jump_timer >= self.jump_interval:
                self.vel_y = config.WHITE_CAT_JUMP_VELOCITY  # ì í”„ ì†ë„ ì„¤ì • (ìŒìˆ˜ = ìœ„ë¡œ)
                self.jump_timer = 0  # íƒ€ì´ë¨¸ ë¦¬ì…‹
            
            # ì¤‘ë ¥ ì ìš© (ì í”„ í›„ ë‚™í•˜)
            self.vel_y += config.WHITE_CAT_GRAVITY
            
            # Yì¶• ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            self.rect.y += self.vel_y
            
            # ===== ì§€ë©´ ì²˜ë¦¬ =====
            # ë°”ë‹¥ì— ë‹¿ìœ¼ë©´ ì í”„ ì†ë„ ì´ˆê¸°í™”
            if self.rect.bottom >= config.HEIGHT - 50:
                self.rect.bottom = config.HEIGHT - 50  # ë°”ë‹¥ì— ê³ ì •
                self.vel_y = 0  # ë‚™í•˜ ì†ë„ ì´ˆê¸°í™”
        
        # ===== ê³ ì–‘ì´ ì´ë™ =====
        # ê³ ì–‘ì´ë¥¼ ì™¼ìª½ìœ¼ë¡œ ì´ë™ (Xì¢Œí‘œ ê°ì†Œ)
        self.rect.x -= self.speed
        
        # ===== í™”ë©´ ê²½ê³„ ì²´í¬ =====
        # í™”ë©´ ì™¼ìª½ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ ì œê±° (ë©”ëª¨ë¦¬ ì ˆì•½)
        if self.rect.right < 0:
            self.kill()  # ìŠ¤í”„ë¼ì´íŠ¸ë¥¼ ì œê±°í•˜ê³  ë©”ëª¨ë¦¬ì—ì„œ í•´ì œ

# ============================================================================
# ğŸ‘‘ ë³´ìŠ¤ ê³ ì–‘ì´ í´ë˜ìŠ¤ (BossCat Class)
# ============================================================================
# ë³´ìŠ¤ ê³ ì–‘ì´ëŠ” ê° ìŠ¤í…Œì´ì§€ì˜ ìµœì¢… ë³´ìŠ¤ì…ë‹ˆë‹¤.
# ì¼ë°˜ ê³ ì–‘ì´ë³´ë‹¤ í›¨ì”¬ ê°•í•˜ë©°, ëŒì„ ë˜ì ¸ì„œ ê³µê²©í•©ë‹ˆë‹¤.

class BossCat(pygame.sprite.Sprite):
    """
    ë³´ìŠ¤ ê³ ì–‘ì´ í´ë˜ìŠ¤
    
    ì£¼ìš” ê¸°ëŠ¥:
    - ë†’ì€ ì²´ë ¥ê³¼ ê³µê²©ë ¥
    - ì£¼ê¸°ì ìœ¼ë¡œ ëŒì„ ë˜ì ¸ì„œ ê³µê²©
    - ìˆ˜ë¦¬ê²€ì— ë§ìœ¼ë©´ ì²´ë ¥ ê°ì†Œ
    - ì²´ë ¥ì´ 0ì´ ë˜ë©´ ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì§„í–‰
    - ìŠ¤í…Œì´ì§€ê°€ ì˜¬ë¼ê°ˆìˆ˜ë¡ ì²´ë ¥ ì¦ê°€
    
    pygame.sprite.Spriteë¥¼ ìƒì†ë°›ì•„ Pygameì˜ ìŠ¤í”„ë¼ì´íŠ¸ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    """
    
    def __init__(self, x, y, stage=1):
        """
        ë³´ìŠ¤ ê³ ì–‘ì´ ì´ˆê¸°í™” - ë³´ìŠ¤ ê°ì²´ê°€ ìƒì„±ë  ë•Œ í•œ ë²ˆë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
        
        Args:
            x: ë³´ìŠ¤ ì‹œì‘ X ì¢Œí‘œ (ë³´í†µ í™”ë©´ ì˜¤ë¥¸ìª½ì—ì„œ ì‹œì‘)
            y: ë³´ìŠ¤ ì‹œì‘ Y ì¢Œí‘œ (ë³´í†µ ì§€ë©´ ë†’ì´)
            stage: í˜„ì¬ ìŠ¤í…Œì´ì§€ (ì²´ë ¥ ê³„ì‚°ì— ì‚¬ìš©, ê¸°ë³¸ê°’: 1)
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - ë³´ìŠ¤ì˜ í¬ê¸°ì™€ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        - ë³´ìŠ¤ì˜ ì²´ë ¥ì„ ì„¤ì •í•©ë‹ˆë‹¤ (ìŠ¤í…Œì´ì§€ì— ë”°ë¼ ì¦ê°€)
        - ë³´ìŠ¤ì˜ ê³µê²© ê´€ë ¨ ë³€ìˆ˜ë“¤ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤
        """
        super().__init__()  # pygame.sprite.Sprite ì´ˆê¸°í™” (ë°˜ë“œì‹œ í•„ìš”)
        
        # ===== ë³´ìŠ¤ í¬ê¸° ì„¤ì • =====
        self.width = config.BOSS_CAT_WIDTH   # ë³´ìŠ¤ ë„ˆë¹„ (config.pyì—ì„œ ê°€ì ¸ì˜´)
        self.height = config.BOSS_CAT_HEIGHT # ë³´ìŠ¤ ë†’ì´ (config.pyì—ì„œ ê°€ì ¸ì˜´)
        
        # ===== ë³´ìŠ¤ ì´ë¯¸ì§€ ë¡œë“œ ë° í¬ê¸° ì¡°ì • =====
        try:
            # assets/cat_boss.png íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ ë³´ìŠ¤ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©
            self.original_image = pygame.image.load("assets/cat_boss.png").convert_alpha()
            
            # config.pyì— ì •ì˜ëœ í¬ê¸°ë¡œ ì´ë¯¸ì§€ ì¡°ì •
            self.image = pygame.transform.scale(self.original_image, (self.width, self.height))
            
            # ë³´ìŠ¤ ê³ ì–‘ì´ë„ ì™¼ìª½ì„ í–¥í•˜ë„ë¡ ì´ë¯¸ì§€ë¥¼ ì¢Œìš° ë°˜ì „
            self.image = pygame.transform.flip(self.image, True, False)
        except:
            # ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¹¨ê°„ìƒ‰ ì‚¬ê°í˜•ìœ¼ë¡œ ëŒ€ì²´
            self.image = pygame.Surface((self.width, self.height))
            self.image.fill(config.RED)  # ë¹¨ê°„ìƒ‰ ì‚¬ê°í˜•
            print("âš ï¸ ë³´ìŠ¤ ê³ ì–‘ì´ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ - ê¸°ë³¸ ì‚¬ê°í˜• ì‚¬ìš©")
        
        # ===== ë³´ìŠ¤ì˜ ì¶©ëŒ ì˜ì—­ ì„¤ì • =====
        # rectëŠ” ë³´ìŠ¤ì˜ ì¶©ëŒ ì˜ì—­ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤
        # midbottom=(x, y)ëŠ” ì‚¬ê°í˜•ì˜ í•˜ë‹¨ ì¤‘ì•™ì„ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        self.rect = self.image.get_rect(midbottom=(x, y))
        
        # ===== ë³´ìŠ¤ ì²´ë ¥ ì„¤ì • =====
        # ìŠ¤í…Œì´ì§€ì— ë”°ë¼ ì²´ë ¥ì´ ì¦ê°€í•©ë‹ˆë‹¤
        # ê¸°ë³¸ ì²´ë ¥ * 2^(ìŠ¤í…Œì´ì§€-1) ê³µì‹ìœ¼ë¡œ ê³„ì‚°
        # ì˜ˆ: ìŠ¤í…Œì´ì§€ 1 = 50, ìŠ¤í…Œì´ì§€ 2 = 100, ìŠ¤í…Œì´ì§€ 3 = 200
        self.hp = config.BASE_BOSS_HP * (2 ** (stage - 1))
        
        # ===== ë³´ìŠ¤ ê³µê²© ê´€ë ¨ ë³€ìˆ˜ =====
        self.attack_timer = 0        # ê³µê²© íƒ€ì´ë¨¸ (ê³µê²© ê°„ê²© ì¡°ì ˆìš©)
        self.attack_interval = config.BOSS_ATTACK_INTERVAL  # ê³µê²© ê°„ê²© (configì—ì„œ ê°€ì ¸ì˜´)
        
        # ë³´ìŠ¤ ìŠ¤í° ì‹œ ì½˜ì†”ì— ì •ë³´ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
        print(f"ğŸ‘‘ ë³´ìŠ¤ ê³ ì–‘ì´ ìŠ¤í°! ì²´ë ¥: {self.hp}, ìŠ¤í…Œì´ì§€: {stage}")
    
    def update(self, keys=None):
        """
        ë³´ìŠ¤ ê³ ì–‘ì´ ìƒíƒœ ì—…ë°ì´íŠ¸ - ë§¤ í”„ë ˆì„ë§ˆë‹¤ í˜¸ì¶œë©ë‹ˆë‹¤.
        
        Args:
            keys: í‚¤ ì…ë ¥ (ë³´ìŠ¤ëŠ” ìë™ ë™ì‘í•˜ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - ë³´ìŠ¤ì˜ ê³µê²© íƒ€ì´ë¨¸ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤
        - ê³µê²© ê°„ê²©ì— ë„ë‹¬í•˜ë©´ ëŒì„ ë˜ì§‘ë‹ˆë‹¤
        - ëŒì„ ì ì ˆí•œ ìŠ¤í”„ë¼ì´íŠ¸ ê·¸ë£¹ì— ì¶”ê°€í•©ë‹ˆë‹¤
        """
        # ===== ê³µê²© íƒ€ì´ë¨¸ ê´€ë¦¬ =====
        # ê³µê²© íƒ€ì´ë¨¸ ì¦ê°€ (ì•½ 60FPS ê¸°ì¤€ìœ¼ë¡œ 16msì”© ì¦ê°€)
        self.attack_timer += 16
        
        # ===== ê³µê²© ì‹¤í–‰ =====
        # ê³µê²© ê°„ê²©ì— ë„ë‹¬í•˜ë©´ ëŒ ë˜ì§€ê¸°
        if self.attack_timer >= self.attack_interval:
            self.attack_timer = 0  # íƒ€ì´ë¨¸ ë¦¬ì…‹
            
            # ===== ëŒ ìƒì„± ë° ë˜ì§€ê¸° =====
            # ë³´ìŠ¤ ìœ„ì¹˜ì—ì„œ ì•½ê°„ ì˜¤í”„ì…‹ëœ ìœ„ì¹˜ì— ëŒ ìƒì„±
            # config.pyì—ì„œ ì„¤ì •ëœ ì˜¤í”„ì…‹ ê°’ ì‚¬ìš©
            stone_x = self.rect.centerx + config.STONE_SPAWN_OFFSET_X  # Xì¶• ì˜¤í”„ì…‹
            stone_y = self.rect.bottom + config.STONE_SPAWN_OFFSET_Y   # Yì¶• ì˜¤í”„ì…‹
            
            # Stone ê°ì²´ ìƒì„± (ìƒˆë¡œìš´ ëŒ ê³µê²©)
            stone = Stone(stone_x, stone_y)
            
            # ëŒì„ ì ì ˆí•œ ìŠ¤í”„ë¼ì´íŠ¸ ê·¸ë£¹ì— ì¶”ê°€
            stones.add(stone)        # stones ê·¸ë£¹ì— ì¶”ê°€ (ëŒ ê´€ë¦¬ìš©)
            all_sprites.add(stone)   # ì „ì²´ ìŠ¤í”„ë¼ì´íŠ¸ ê·¸ë£¹ì— ì¶”ê°€ (í™”ë©´ í‘œì‹œìš©)
            
            # ëŒ ë˜ì§€ê¸° ë¡œê·¸ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            print(f"ğŸª¨ ë³´ìŠ¤ê°€ ëŒì„ ë˜ì¡ŒìŠµë‹ˆë‹¤! ìœ„ì¹˜: ({stone_x}, {stone_y})")
        
        # ===== ë³´ìŠ¤ ë™ì‘ =====
        # ë³´ìŠ¤ëŠ” ì œìë¦¬ì— ê³ ì • (ì´ë™í•˜ì§€ ì•ŠìŒ)
        # í•„ìš”ì‹œ ì—¬ê¸°ì— ë³´ìŠ¤ ì´ë™ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
        # ì˜ˆ: í”Œë ˆì´ì–´ë¥¼ í–¥í•´ ì´ë™, íŒ¨í„´ë³„ ì›€ì§ì„ ë“±

# ============================================================================
# ğŸª ê°„ì‹ í´ë˜ìŠ¤ (Snack Class)
# ============================================================================
# ê°„ì‹ì€ í”Œë ˆì´ì–´ê°€ íšë“í•˜ë©´ ë”ë¸” ìˆ˜ë¦¬ê²€ íš¨ê³¼ë¥¼ ì£¼ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.
# ê° ìŠ¤í…Œì´ì§€ë§ˆë‹¤ í•œ ë²ˆë§Œ ìŠ¤í°ë˜ë©°, í”Œë ˆì´ì–´ê°€ ë¨¹ìœ¼ë©´ íš¨ê³¼ê°€ ì ìš©ë©ë‹ˆë‹¤.

class Snack(pygame.sprite.Sprite):
    """
    ê°„ì‹ í´ë˜ìŠ¤
    
    ì£¼ìš” ê¸°ëŠ¥:
    - í”Œë ˆì´ì–´ê°€ íšë“í•˜ë©´ ë”ë¸” ìˆ˜ë¦¬ê²€ íš¨ê³¼ í™œì„±í™”
    - íš¨ê³¼ ì§€ì† ì‹œê°„ ë™ì•ˆ ë‘ ê°œì˜ ìˆ˜ë¦¬ê²€ì„ ë™ì‹œì— ë°œì‚¬
    - ì™¼ìª½ìœ¼ë¡œ ìë™ ì´ë™
    - í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ ì œê±°
    
    pygame.sprite.Spriteë¥¼ ìƒì†ë°›ì•„ Pygameì˜ ìŠ¤í”„ë¼ì´íŠ¸ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    """
    
    def __init__(self, x, y):
        """
        ê°„ì‹ ì´ˆê¸°í™” - ê°„ì‹ ê°ì²´ê°€ ìƒì„±ë  ë•Œ í•œ ë²ˆë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
        
        Args:
            x: ê°„ì‹ ì‹œì‘ X ì¢Œí‘œ (ë³´í†µ í™”ë©´ ì˜¤ë¥¸ìª½ì—ì„œ ì‹œì‘)
            y: ê°„ì‹ ì‹œì‘ Y ì¢Œí‘œ (ë³´í†µ ì§€ë©´ ìœ„ìª½)
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - ê°„ì‹ì˜ í¬ê¸°ì™€ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        - ê°„ì‹ì˜ ì´ˆê¸° ìœ„ì¹˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        - ê°„ì‹ì˜ ì´ë™ ì†ë„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        """
        super().__init__()  # pygame.sprite.Sprite ì´ˆê¸°í™” (ë°˜ë“œì‹œ í•„ìš”)
        
        # ===== ê°„ì‹ í¬ê¸° ì„¤ì • =====
        self.size = config.SNACK_SIZE  # ê°„ì‹ í¬ê¸° (config.pyì—ì„œ ê°€ì ¸ì˜´)
        
        # ===== ê°„ì‹ ì´ë¯¸ì§€ ë¡œë“œ ë° í¬ê¸° ì¡°ì • =====
        try:
            # assets/snack.png íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ ê°„ì‹ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©
            self.original_image = pygame.image.load("assets/snack.png").convert_alpha()
            
            # config.pyì— ì •ì˜ëœ í¬ê¸°ë¡œ ì´ë¯¸ì§€ ì¡°ì •
            self.image = pygame.transform.scale(self.original_image, (self.size, self.size))
        except:
            # ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì´ˆë¡ìƒ‰ ì‚¬ê°í˜•ìœ¼ë¡œ ëŒ€ì²´
            self.image = pygame.Surface((self.size, self.size))
            self.image.fill(config.GREEN)  # ì´ˆë¡ìƒ‰ ì‚¬ê°í˜•
            print("âš ï¸ ê°„ì‹ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ - ê¸°ë³¸ ì‚¬ê°í˜• ì‚¬ìš©")
        
        # ===== ê°„ì‹ì˜ ì¶©ëŒ ì˜ì—­ ì„¤ì • =====
        # rectëŠ” ê°„ì‹ì˜ ì¶©ëŒ ì˜ì—­ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤
        # center=(x, y)ëŠ” ì‚¬ê°í˜•ì˜ ì¤‘ì‹¬ì„ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        self.rect = self.image.get_rect(center=(x, y))
        
        # ===== ê°„ì‹ ì´ë™ ì†ë„ ì„¤ì • =====
        # ê°„ì‹ ì´ë™ ì†ë„ (config.pyì—ì„œ ê°€ì ¸ì˜´)
        # ì–‘ìˆ˜ ê°’ì´ë¯€ë¡œ ì˜¤ë¥¸ìª½ì—ì„œ ì™¼ìª½ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤
        self.speed = config.SNACK_SPEED
    
    def update(self, keys=None):
        """
        ê°„ì‹ ìƒíƒœ ì—…ë°ì´íŠ¸ - ë§¤ í”„ë ˆì„ë§ˆë‹¤ í˜¸ì¶œë©ë‹ˆë‹¤.
        
        Args:
            keys: í‚¤ ì…ë ¥ (ê°„ì‹ì€ ìë™ ì´ë™í•˜ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - ê°„ì‹ì„ ì™¼ìª½ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
        - í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ìœ¼ë¡œ ì œê±°í•©ë‹ˆë‹¤
        """
        # ===== ê°„ì‹ ì´ë™ =====
        # ê°„ì‹ì„ ì™¼ìª½ìœ¼ë¡œ ì´ë™ (Xì¢Œí‘œ ê°ì†Œ)
        self.rect.x -= self.speed
        
        # ===== í™”ë©´ ê²½ê³„ ì²´í¬ =====
        # í™”ë©´ ì™¼ìª½ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ ì œê±° (ë©”ëª¨ë¦¬ ì ˆì•½)
        if self.rect.right < 0:
            self.kill()  # ìŠ¤í”„ë¼ì´íŠ¸ë¥¼ ì œê±°í•˜ê³  ë©”ëª¨ë¦¬ì—ì„œ í•´ì œ

# ============================================================================
# ğŸ• ê°•ì•„ì§€ ë°©ì–´ ì•„ì´í…œ í´ë˜ìŠ¤ (Puppy Class)
# ============================================================================
# PuppyëŠ” í”Œë ˆì´ì–´ê°€ íšë“í•˜ë©´ ë°©ì–´ íš¨ê³¼ë¥¼ ì£¼ëŠ” íŠ¹ë³„í•œ ì•„ì´í…œì…ë‹ˆë‹¤.
# í”Œë ˆì´ì–´ê°€ ê³ ì–‘ì´, ë³´ìŠ¤, ëŒê³¼ ì¶©ëŒí•´ë„ ê²Œì„ì˜¤ë²„ë˜ì§€ ì•Šê²Œ í•´ì¤ë‹ˆë‹¤.

class Puppy(pygame.sprite.Sprite):
    """
    ê°•ì•„ì§€ ë°©ì–´ ì•„ì´í…œ í´ë˜ìŠ¤
    
    ì£¼ìš” ê¸°ëŠ¥:
    - í”Œë ˆì´ì–´ê°€ íšë“í•˜ë©´ ë°©ì–´ íš¨ê³¼ í™œì„±í™”
    - ì¶©ëŒ ì‹œ ìë™ìœ¼ë¡œ ë°©ì–´ íš¨ê³¼ ì†Œëª¨
    - ë°©ì–´ íšŸìˆ˜ë§Œí¼ ì¶©ëŒì„ ë§‰ì•„ì¤Œ
    - ì™¼ìª½ìœ¼ë¡œ ìë™ ì´ë™
    - í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ ì œê±°
    
    pygame.sprite.Spriteë¥¼ ìƒì†ë°›ì•„ Pygameì˜ ìŠ¤í”„ë¼ì´íŠ¸ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    """
    
    def __init__(self, x, y):
        """
        ê°•ì•„ì§€ ë°©ì–´ ì•„ì´í…œ ì´ˆê¸°í™” - puppy ê°ì²´ê°€ ìƒì„±ë  ë•Œ í•œ ë²ˆë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
        
        Args:
            x: puppy ì‹œì‘ X ì¢Œí‘œ (ë³´í†µ í™”ë©´ ì˜¤ë¥¸ìª½ì—ì„œ ì‹œì‘)
            y: puppy ì‹œì‘ Y ì¢Œí‘œ (ë³´í†µ ì§€ë©´ ìœ„ìª½)
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - puppyì˜ í¬ê¸°ì™€ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        - puppyì˜ ì´ˆê¸° ìœ„ì¹˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        - puppyì˜ ì´ë™ ì†ë„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        """
        super().__init__()  # pygame.sprite.Sprite ì´ˆê¸°í™” (ë°˜ë“œì‹œ í•„ìš”)
        
        # ===== puppy í¬ê¸° ì„¤ì • =====
        self.size = config.PUPPY_SIZE  # puppy í¬ê¸° (config.pyì—ì„œ ê°€ì ¸ì˜´)
        
        # ===== puppy ì´ë¯¸ì§€ ë¡œë“œ ë° í¬ê¸° ì¡°ì • =====
        try:
            # assets/puppy.png íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ puppy ì´ë¯¸ì§€ë¡œ ì‚¬ìš©
            self.original_image = pygame.image.load("assets/puppy.png").convert_alpha()
            
            # ì´ë¯¸ì§€ í¬ê¸° ì¡°ì •
            self.original_image = pygame.transform.scale(self.original_image, (self.size, self.size))
            
            # ì¢Œìš° ë°˜ì „ëœ ì´ë¯¸ì§€ (ì™¼ìª½ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™í•˜ë¯€ë¡œ ë°˜ì „ í•„ìš”)
            # transform.flip(ì´ë¯¸ì§€, ê°€ë¡œë°˜ì „, ì„¸ë¡œë°˜ì „)
            # True = ê°€ë¡œ ë°˜ì „, False = ì„¸ë¡œ ë°˜ì „ ì•ˆí•¨
            self.image = pygame.transform.flip(self.original_image, True, False)
        except:
            # ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì—°í•œ ì£¼í™©ìƒ‰ ì‚¬ê°í˜•ìœ¼ë¡œ ëŒ€ì²´
            self.image = pygame.Surface((self.size, self.size))
            self.image.fill((255, 200, 100))  # ì—°í•œ ì£¼í™©ìƒ‰
            print("âš ï¸ ê°•ì•„ì§€ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ - ê¸°ë³¸ ì‚¬ê°í˜• ì‚¬ìš©")
        
        # ===== puppyì˜ ì¶©ëŒ ì˜ì—­ ì„¤ì • =====
        # rectëŠ” puppyì˜ ì¶©ëŒ ì˜ì—­ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤
        # center=(x, y)ëŠ” ì‚¬ê°í˜•ì˜ ì¤‘ì‹¬ì„ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        self.rect = self.image.get_rect(center=(x, y))
        
        # ===== puppy ì´ë™ ì†ë„ ì„¤ì • =====
        # puppy ì´ë™ ì†ë„ (ê³ ì •ê°’, configì—ì„œ ê°€ì ¸ì˜¤ì§€ ì•ŠìŒ)
        # ì–‘ìˆ˜ ê°’ì´ë¯€ë¡œ ì˜¤ë¥¸ìª½ì—ì„œ ì™¼ìª½ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤
        self.speed = 3
    
    def update(self, keys=None):
        """
        ê°•ì•„ì§€ ë°©ì–´ ì•„ì´í…œ ìƒíƒœ ì—…ë°ì´íŠ¸ - ë§¤ í”„ë ˆì„ë§ˆë‹¤ í˜¸ì¶œë©ë‹ˆë‹¤.
        
        Args:
            keys: í‚¤ ì…ë ¥ (puppyëŠ” ìë™ ì´ë™í•˜ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - puppyë¥¼ ì™¼ìª½ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
        - í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ìœ¼ë¡œ ì œê±°í•©ë‹ˆë‹¤
        """
        # ===== puppy ì´ë™ =====
        # puppyë¥¼ ì™¼ìª½ìœ¼ë¡œ ì´ë™ (Xì¢Œí‘œ ê°ì†Œ)
        self.rect.x -= self.speed
        
        # ===== í™”ë©´ ê²½ê³„ ì²´í¬ =====
        # í™”ë©´ ì™¼ìª½ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ ì œê±° (ë©”ëª¨ë¦¬ ì ˆì•½)
        if self.rect.right < 0:
            self.kill()  # ìŠ¤í”„ë¼ì´íŠ¸ë¥¼ ì œê±°í•˜ê³  ë©”ëª¨ë¦¬ì—ì„œ í•´ì œ

# ============================================================================
# ğŸª¨ ëŒ ê³µê²© í´ë˜ìŠ¤ (Stone Class)
# ============================================================================
# Stoneì€ ë³´ìŠ¤ ê³ ì–‘ì´ê°€ ë˜ì§€ëŠ” ê³µê²© ë¬´ê¸°ì…ë‹ˆë‹¤.
# í”Œë ˆì´ì–´ì™€ ì¶©ëŒí•˜ë©´ ê²Œì„ì˜¤ë²„ê°€ ë˜ë©°, ì¤‘ë ¥ì˜ ì˜í–¥ì„ ë°›ì•„ í¬ë¬¼ì„ ì„ ê·¸ë¦¬ë©° ì´ë™í•©ë‹ˆë‹¤.

class Stone(pygame.sprite.Sprite):
    """
    ëŒ ê³µê²© í´ë˜ìŠ¤
    
    ì£¼ìš” ê¸°ëŠ¥:
    - ë³´ìŠ¤ ê³ ì–‘ì´ê°€ ì£¼ê¸°ì ìœ¼ë¡œ ë˜ì§€ëŠ” ê³µê²©
    - ì¤‘ë ¥ì˜ ì˜í–¥ì„ ë°›ì•„ í¬ë¬¼ì„  ê¶¤ë„ë¡œ ì´ë™
    - í”Œë ˆì´ì–´ì™€ ì¶©ëŒ ì‹œ ê²Œì„ì˜¤ë²„
    - í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ ì œê±°
    
    pygame.sprite.Spriteë¥¼ ìƒì†ë°›ì•„ Pygameì˜ ìŠ¤í”„ë¼ì´íŠ¸ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    """
    
    def __init__(self, x, y):
        """
        ëŒ ê³µê²© ì´ˆê¸°í™” - ëŒ ê°ì²´ê°€ ìƒì„±ë  ë•Œ í•œ ë²ˆë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
        
        Args:
            x: ëŒ ì‹œì‘ X ì¢Œí‘œ (ë³´í†µ ë³´ìŠ¤ ê³ ì–‘ì´ ìœ„ì¹˜ì—ì„œ ì‹œì‘)
            y: ëŒ ì‹œì‘ Y ì¢Œí‘œ (ë³´í†µ ë³´ìŠ¤ ê³ ì–‘ì´ ì•„ë˜ìª½)
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - ëŒì˜ í¬ê¸°ì™€ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        - ëŒì˜ ì´ˆê¸° ìœ„ì¹˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        - ëŒì˜ ë¬¼ë¦¬ ì†ì„±(ì†ë„, ì¤‘ë ¥ ë“±)ì„ ì„¤ì •í•©ë‹ˆë‹¤
        """
        super().__init__()  # pygame.sprite.Sprite ì´ˆê¸°í™” (ë°˜ë“œì‹œ í•„ìš”)
        
        # ===== ëŒ í¬ê¸° ì„¤ì • =====
        self.radius = config.STONE_RADIUS  # ëŒ ë°˜ì§€ë¦„ (config.pyì—ì„œ ê°€ì ¸ì˜´)
        
        # ===== ëŒ ì´ë¯¸ì§€ ë¡œë“œ ë° í¬ê¸° ì¡°ì • =====
        try:
            # assets/stone.png íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ ëŒ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©
            self.original_image = pygame.image.load("assets/stone.png").convert_alpha()
            
            # ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • (radius*2 x radius*2)
            # ëŒì˜ ì§€ë¦„ì€ ë°˜ì§€ë¦„ì˜ 2ë°°ì´ë¯€ë¡œ (radius*2, radius*2) í¬ê¸°ë¡œ ì„¤ì •
            self.image = pygame.transform.scale(self.original_image, (self.radius*2, self.radius*2))
        except:
            # ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ íšŒìƒ‰ ì›ìœ¼ë¡œ ëŒ€ì²´
            # SRCALPHAëŠ” íˆ¬ëª…ë„ë¥¼ ì§€ì›í•˜ëŠ” Surfaceë¥¼ ìƒì„±í•©ë‹ˆë‹¤
            self.image = pygame.Surface((self.radius*2, self.radius*2), pygame.SRCALPHA)
            
            # draw_circle(ì´ë¯¸ì§€, ìƒ‰ìƒ, (x, y), ë°˜ì§€ë¦„)ìœ¼ë¡œ ì›ì„ ê·¸ë¦½ë‹ˆë‹¤
            # (radius, radius)ëŠ” Surfaceì˜ ì¤‘ì‹¬ì ì…ë‹ˆë‹¤
            pygame.draw.circle(self.image, config.GRAY, (self.radius, self.radius), self.radius)
            print("âš ï¸ ëŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ - ê¸°ë³¸ ì›í˜• ì‚¬ìš©")
        
        # ===== ëŒì˜ ì¶©ëŒ ì˜ì—­ ì„¤ì • =====
        # rectëŠ” ëŒì˜ ì¶©ëŒ ì˜ì—­ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤
        # center=(x, y)ëŠ” ì‚¬ê°í˜•ì˜ ì¤‘ì‹¬ì„ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        self.rect = self.image.get_rect(center=(x, y))
        
        # ===== ëŒì˜ ë¬¼ë¦¬ ì†ì„± ì„¤ì • =====
        # ì™¼ìª½ìœ¼ë¡œë§Œ ë˜ì§€ê¸° (ëœë¤ ì†ë„)
        # random.randint(ìµœì†Œê°’, ìµœëŒ€ê°’)ìœ¼ë¡œ ëœë¤í•œ ì†ë„ ìƒì„±
        random_speed = random.randint(config.STONE_SPEED_MIN, config.STONE_SPEED_MAX)
        self.vel_x = -random_speed  # ì™¼ìª½ìœ¼ë¡œ ì´ë™ (ìŒìˆ˜ = ì™¼ìª½, ëœë¤ ì†ë„)
        self.vel_y = 0              # ìˆ˜í‰ìœ¼ë¡œë§Œ ë°œì‚¬ (ìœ„ì•„ë˜ ì›€ì§ì„ ì—†ìŒ, ì´ˆê¸°ê°’)
        
        # ===== ì¤‘ë ¥ ì„¤ì • =====
        # ì¤‘ë ¥ ì„¤ì • (config.pyì—ì„œ ê°€ì ¸ì˜´)
        # ì–‘ìˆ˜ ê°’ì´ë¯€ë¡œ ì•„ë˜ìª½ìœ¼ë¡œ ê°€ì†ë©ë‹ˆë‹¤
        self.gravity = config.STONE_GRAVITY
    
    def update(self, keys=None):
        """
        ëŒ ê³µê²© ìƒíƒœ ì—…ë°ì´íŠ¸ - ë§¤ í”„ë ˆì„ë§ˆë‹¤ í˜¸ì¶œë©ë‹ˆë‹¤.
        
        Args:
            keys: í‚¤ ì…ë ¥ (ëŒì€ ìë™ ì´ë™í•˜ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        
        ì´ ë©”ì„œë“œì—ì„œ:
        - ì¤‘ë ¥ì„ ì ìš©í•˜ì—¬ ëŒì„ ì•„ë˜ìª½ìœ¼ë¡œ ê°€ì†ì‹œí‚µë‹ˆë‹¤
        - ëŒì˜ ìœ„ì¹˜ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤
        - í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ìë™ìœ¼ë¡œ ì œê±°í•©ë‹ˆë‹¤
        """
        # ===== ì¤‘ë ¥ ì ìš© =====
        # ì¤‘ë ¥ìœ¼ë¡œ ì¸í•´ ì•„ë˜ìª½ìœ¼ë¡œ ê°€ì† (Yì¶• ì†ë„ ì¦ê°€)
        self.vel_y += self.gravity
        
        # ===== ìœ„ì¹˜ ì—…ë°ì´íŠ¸ =====
        self.rect.x += self.vel_x  # Xì¶• ì´ë™ (ì™¼ìª½ìœ¼ë¡œ ì¼ì •í•œ ì†ë„)
        self.rect.y += self.vel_y  # Yì¶• ì´ë™ (ì¤‘ë ¥ì˜ ì˜í–¥ì„ ë°›ì•„ ê°€ì†)
        
        # ===== í™”ë©´ ê²½ê³„ ì²´í¬ ë° ì œê±° =====
        # ìœ„ìª½ ê²½ê³„: í™”ë©´ ìœ„ë¡œ ë‚˜ê°€ë©´ ì œê±°
        if self.rect.top > config.HEIGHT:
            self.kill()
        # ì™¼ìª½ ê²½ê³„: í™”ë©´ ì™¼ìª½ìœ¼ë¡œ ë‚˜ê°€ë©´ ì œê±°
        if self.rect.left < 0:
            self.kill()
        # ì˜¤ë¥¸ìª½ ê²½ê³„: í™”ë©´ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë‚˜ê°€ë©´ ì œê±°
        if self.rect.right > config.WIDTH:
            self.kill()


# --- ê·¸ë£¹ ---
all_sprites = pygame.sprite.Group()
enemies = pygame.sprite.Group()
shurikens = pygame.sprite.Group()
items = pygame.sprite.Group()
puppies = pygame.sprite.Group()  # ê°•ì•„ì§€ ì•„ì´í…œ ê·¸ë£¹
stones = pygame.sprite.Group()

player = Player()
all_sprites.add(player)

game_over = False
game_clear = False
spawn_timer = 0
snack_spawn_timer = 0
boss_spawned = False

def get_touch_rect(sprite, margin):
    rect = sprite.rect.copy()
    rect.inflate_ip(-margin*2, -margin*2)
    return rect

def draw_text(text, x, y, color=config.WHITE, font_type=font):
    img = font_type.render(text, True, color)
    screen.blit(img, (x, y))

def draw_centered_text(text, y, color=config.WHITE, font_type=font):
    img = font_type.render(text, True, color)
    x = (config.WIDTH - img.get_width()) // 2
    screen.blit(img, (x, y))

def load_highscores():
    """í•˜ì´ìŠ¤ì½”ì–´ JSON íŒŒì¼ ë¡œë“œ (ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜)"""
    path = config.HIGHSCORES_FILE
    try:
        if not os.path.exists(path):
            return []
        with open(path, "r", encoding="utf-8") as f:
            data = json.load(f)
            if isinstance(data, list):
                data.sort(key=lambda r: (-int(r.get("score", 0)), float(r.get("time", 0.0))))
                return data[:10]
            return []
    except Exception as e:
        print(f"âš ï¸ í•˜ì´ìŠ¤ì½”ì–´ ë¡œë“œ ì‹¤íŒ¨: {e}")
        return []

def save_highscores(records):
    """í•˜ì´ìŠ¤ì½”ì–´ JSON ì €ì¥. ìƒìœ„ 10ê°œë§Œ ì €ì¥"""
    try:
        records = list(records)
        records.sort(key=lambda r: (-int(r.get("score", 0)), float(r.get("time", 0.0))))
        with open(config.HIGHSCORES_FILE, "w", encoding="utf-8") as f:
            json.dump(records[:10], f, ensure_ascii=False, indent=2)
    except Exception as e:
        print(f"âš ï¸ í•˜ì´ìŠ¤ì½”ì–´ ì €ì¥ ì‹¤íŒ¨: {e}")

def is_highscore(score, elapsed_seconds, records):
    """í˜„ì¬ ê¸°ë¡ì´ TOP 10ì— ë“œëŠ”ì§€ ì—¬ë¶€"""
    if not records or len(records) < 10:
        return True
    records = sorted(records, key=lambda r: (-int(r.get("score", 0)), float(r.get("time", 0.0))))
    last = records[-1]
    last_score = int(last.get("score", 0))
    last_time = float(last.get("time", 0.0))
    if score > last_score:
        return True
    if score == last_score and elapsed_seconds < last_time:
        return True
    return False

def is_top10_score(score, elapsed_seconds, records):
    """í˜„ì¬ ì ìˆ˜ê°€ TOP 10ì— ì‹¤ì œë¡œ ë“¤ì–´ê°€ëŠ”ì§€ ì—¬ë¶€"""
    if not records or len(records) < 10:
        return True
    
    # í˜„ì¬ ê¸°ë¡ë“¤ì„ ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ, ì‹œê°„ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
    sorted_records = sorted(records, key=lambda r: (-int(r.get("score", 0)), float(r.get("time", 0.0))))
    
    # TOP 10ì˜ ë§ˆì§€ë§‰ ê¸°ë¡ê³¼ ë¹„êµ
    last_record = sorted_records[9]  # 10ë²ˆì§¸ ê¸°ë¡ (0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ ì¸ë±ìŠ¤ 9)
    last_score = int(last_record.get("score", 0))
    last_time = float(last_record.get("time", 0.0))
    
    # ì ìˆ˜ê°€ ë” ë†’ê±°ë‚˜, ì ìˆ˜ê°€ ê°™ê³  ì‹œê°„ì´ ë” ë¹ ë¥´ë©´ TOP 10 ì§„ì…
    if score > last_score:
        return True
    if score == last_score and elapsed_seconds < last_time:
        return True
    return False

def draw_clouds():
    """ë°°ê²½ì— êµ¬ë¦„ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜"""
    cloud_color = (255, 255, 255)  # í°ìƒ‰ êµ¬ë¦„
    
    # êµ¬ë¦„ 1 (ì™¼ìª½ ìœ„)
    pygame.draw.ellipse(screen, cloud_color, (50, 80, 120, 60))
    pygame.draw.ellipse(screen, cloud_color, (80, 70, 80, 50))
    pygame.draw.ellipse(screen, cloud_color, (110, 90, 60, 40))
    
    # êµ¬ë¦„ 2 (ì˜¤ë¥¸ìª½ ìœ„)
    pygame.draw.ellipse(screen, cloud_color, (600, 60, 100, 50))
    pygame.draw.ellipse(screen, cloud_color, (630, 50, 70, 40))
    pygame.draw.ellipse(screen, cloud_color, (660, 70, 50, 30))
    
    # êµ¬ë¦„ 3 (ì¤‘ì•™ ìœ„)
    pygame.draw.ellipse(screen, cloud_color, (350, 100, 90, 45))
    pygame.draw.ellipse(screen, cloud_color, (380, 90, 60, 35))
    pygame.draw.ellipse(screen, cloud_color, (410, 105, 40, 25))

def draw_background_elements():
    # ì‚° ê·¸ë¦¬ê¸° (ë©€ë¦¬, í° ì‚¼ê°í˜•)
    mountain_color = (120, 180, 120)
    pygame.draw.polygon(screen, mountain_color, [(100, config.HEIGHT-50), (300, 200), (500, config.HEIGHT-50)])
    pygame.draw.polygon(screen, mountain_color, [(400, config.HEIGHT-50), (600, 250), (800, config.HEIGHT-50)])
    pygame.draw.polygon(screen, (100, 150, 100), [(0, config.HEIGHT-50), (120, 300), (250, config.HEIGHT-50)])

    # ë‚˜ë¬´ ê·¸ë¦¬ê¸° (ì—¬ëŸ¬ ê°œ)
    for x in [150, 250, 600, 700]:
        # ë‚˜ë¬´ ê¸°ë‘¥
        pygame.draw.rect(screen, (100, 60, 20), (x, config.HEIGHT-120, 20, 70))
        # ë‚˜ë­‡ì (ì›)
        pygame.draw.ellipse(screen, (30, 120, 30), (x-20, config.HEIGHT-150, 60, 50))

def draw_menu():
    screen.fill(config.BACKGROUND_COLOR)
    pygame.draw.rect(screen, config.GROUND_COLOR, (0, config.HEIGHT-50, config.WIDTH, 50))
    
    # ê²Œì„ ì œëª©
    draw_centered_text("ê°œ ë‹Œì ëŒ€ëª¨í—˜", 100, config.BLUE, font_title)
    
    # í•˜ì´ìŠ¤ì½”ì–´ TOP 10 (ê°€ìš´ë°)
    highs = load_highscores()
    y0 = 200
    draw_centered_text("TOP 10 í•˜ì´ìŠ¤ì½”ì–´", y0, config.YELLOW, font)
    y = y0 + 30
    if highs:
        for idx, rec in enumerate(highs, start=1):
            name = str(rec.get("name", "???"))[:config.PLAYER_NAME_MAX_LENGTH]
            score_val = int(rec.get("score", 0))
            t = float(rec.get("time", 0))
            draw_centered_text(f"{idx}. {name} - {score_val}ì  ({int(t)}ì´ˆ)", y, config.WHITE, font_small)
            y += 22
    else:
        draw_centered_text("ê¸°ë¡ ì—†ìŒ", y, config.GRAY, font_small)
        y += 22

    # ì¡°ì‘ë²• (í•˜ë‹¨)
    y += 20
    draw_centered_text("ì¡°ì‘ë²•:", y, config.WHITE, font)
    y += 30
    draw_centered_text("â† â†’ : ì´ë™", y, config.WHITE, font_small)
    y += 22
    draw_centered_text("â†‘ : ì í”„", y, config.WHITE, font_small)
    y += 22
    draw_centered_text("ìŠ¤í˜ì´ìŠ¤ë°” : ìˆ˜ë¦¬ê²€ ë°œì‚¬", y, config.WHITE, font_small)
    y += 22
    draw_centered_text("R : ê²Œì„ ì¬ì‹œì‘", y, config.WHITE, font_small)
    
    # ê²Œì„ ì‹œì‘ ì•ˆë‚´
    y += 30
    draw_centered_text("ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆŒëŸ¬ ê²Œì„ ì‹œì‘", y, config.GREEN, font)
    
    pygame.display.flip()

def reset_game():
    global game_over, game_clear, spawn_timer, snack_spawn_timer, puppy_spawn_timer, boss_spawned, cats_spawned, total_cats, current_stage, stage_start_time, score, game_start_ticks, stage_clear_start_time, stage_clear_jump_index
    game_over = False
    game_clear = False
    current_stage = 1  # ìŠ¤í…Œì´ì§€ 1ë¶€í„° ì‹œì‘
    stage_start_time = pygame.time.get_ticks()  # ìŠ¤í…Œì´ì§€ ì‹œì‘ ì‹œê°„ ê¸°ë¡
    game_start_ticks = pygame.time.get_ticks()  # ê²Œì„ ì‹œì‘ ì‹œê°„ ê¸°ë¡
    player.alive = True
    player.rect.bottomleft = (50, config.HEIGHT - 50)
    player.shuriken_double = False
    player.double_end_time = 0
    player.defense_count = 0  # ë°©ì–´ íšŸìˆ˜ ì´ˆê¸°í™”
    player.defense_active = False  # ë°©ì–´ íš¨ê³¼ ì´ˆê¸°í™”
    score = 0  # ì ìˆ˜ ì´ˆê¸°í™”
    stage_clear_start_time = 0  # ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì‹œì‘ ì‹œê°„ ì´ˆê¸°í™”
    stage_clear_jump_index = -1  # ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì í”„ ì¸ë±ìŠ¤ ì´ˆê¸°í™”
    
    # ìŠ¤í”„ë¼ì´íŠ¸ ê·¸ë£¹ ì´ˆê¸°í™”
    for group in [enemies, shurikens, items, puppies, stones]:
        group.empty()
    all_sprites.empty()
    all_sprites.add(player)
    
    # ê²Œì„ ìƒíƒœ ë³€ìˆ˜ ì´ˆê¸°í™”
    spawn_timer = 0
    snack_spawn_timer = 0
    puppy_spawn_timer = 0  # puppy ì „ìš© íƒ€ì´ë¨¸ ì¶”ê°€
    cats_spawned = 0  # ê³ ì–‘ì´ ìŠ¤í° ê°œìˆ˜ ì´ˆê¸°í™” (ì¤‘ìš”!)
    boss_spawned = False  # ë³´ìŠ¤ ìŠ¤í° ìƒíƒœ ì´ˆê¸°í™”
    reset_game.next_puppy_interval = random.randint(config.PUPPY_SPAWN_MIN_INTERVAL, config.PUPPY_SPAWN_MAX_INTERVAL)  # ë‹¤ìŒ puppy ìŠ¤í° ê°„ê²©
    reset_game.snack_spawned = False  # ê°„ì‹ ìŠ¤í° í”Œë˜ê·¸ ì´ˆê¸°í™”
    
    print(f"ğŸ® ê²Œì„ ë¦¬ì…‹ ì™„ë£Œ - cats_spawned: {cats_spawned}, boss_spawned: {boss_spawned}")
    print(f"ğŸ® puppy_spawn_timer: {puppy_spawn_timer}, next_interval: {reset_game.next_puppy_interval}ms")


# ê²Œì„ ìƒíƒœ ë³€ìˆ˜
game_state = "menu"  # "menu", "playing", "name_entry", "stage_clear", "game_over", "game_clear"
current_stage = 1  # í˜„ì¬ ìŠ¤í…Œì´ì§€
cats_spawned = 0
total_cats = config.TOTAL_CATS_TO_SPAWN
stage_start_time = 0  # ìŠ¤í…Œì´ì§€ ì‹œì‘ ì‹œê°„
game_start_ticks = 0  # ê²Œì„ ì‹œì‘ ì‹œê°„
score = 0  # ëˆ„ì  ì ìˆ˜
entered_name = ""  # ì´ë¦„ ì…ë ¥ ë²„í¼
stage_clear_start_time = 0  # ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì‹œì‘ ì‹œê°„
stage_clear_jump_index = -1  # ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì¤‘ ëª‡ ë²ˆì§¸ ì í”„ë¥¼ í–ˆëŠ”ì§€ ì¶”ì  (-1ë¶€í„° ì‹œì‘)
highscores_cache = load_highscores()

running = True
while running:
    dt = clock.tick(config.FPS)
    keys = pygame.key.get_pressed()

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

        if event.type == pygame.KEYDOWN:
            if game_state == "menu":
                if event.key == pygame.K_SPACE:
                    print(f"ğŸ® ë©”ë‰´ì—ì„œ ê²Œì„ ì‹œì‘ - game_state: {game_state} -> playing")
                    game_state = "playing"
                    reset_game()
            
            elif game_state == "playing":
                if event.key == pygame.K_SPACE and player.alive:
                    if player.shuriken_double:
                        sh1 = Shuriken(player.rect.right, player.rect.centery - 10)
                        sh2 = Shuriken(player.rect.right, player.rect.centery + 10)
                        shurikens.add(sh1, sh2)
                        all_sprites.add(sh1, sh2)
                    else:
                        sh = Shuriken(player.rect.right, player.rect.centery)
                        shurikens.add(sh)
                        all_sprites.add(sh)
            elif game_state == "name_entry":
                if event.key == pygame.K_RETURN:
                    name = entered_name.strip() or "PLAYER"
                    elapsed = (pygame.time.get_ticks() - game_start_ticks) / 1000.0
                    highscores_cache.append({"name": name[:config.PLAYER_NAME_MAX_LENGTH], "score": score, "time": round(elapsed, 2)})
                    save_highscores(highscores_cache)
                    highscores_cache = load_highscores()
                    game_state = "game_over"
                elif event.key == pygame.K_BACKSPACE:
                    entered_name = entered_name[:-1]
                else:
                    ch = event.unicode
                    if ch and ch.isprintable() and ch != "\x00":
                        if len(entered_name) < config.PLAYER_NAME_MAX_LENGTH:
                            entered_name += ch
            
            elif game_state in ["game_over", "game_clear"]:
                if event.key == pygame.K_SPACE:
                    print(f"ğŸ® ê²Œì„ ì¬ì‹œì‘ - game_state: {game_state} -> playing")
                    game_state = "playing"
                    reset_game()
                elif event.key == pygame.K_m:
                    print(f"ğŸ® ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸° - game_state: {game_state} -> menu")
                    game_state = "menu"

    if game_state == "menu":
        draw_menu()
    
    elif game_state == "playing":
        all_sprites.update(keys)

        # ê³ ì–‘ì´ ìŠ¤í° ë¡œì§
        if cats_spawned < total_cats and not boss_spawned:
            spawn_timer += dt
            if spawn_timer > config.ENEMY_SPAWN_INTERVAL:
                spawn_timer = 0
                cat_type = random.choice(["yellow", "black", "white"])
                cat = EnemyCat(config.WIDTH + 50, config.HEIGHT - 50, cat_type, current_stage)
                enemies.add(cat)
                all_sprites.add(cat)
                cats_spawned += 1
                print(f"ğŸ± ê³ ì–‘ì´ ìŠ¤í°ë¨ (íƒ€ì…: {cat_type}, ìŠ¤í°ëœ ìˆ˜: {cats_spawned}/{total_cats})")
                print(f"ğŸ± í˜„ì¬ enemies ê·¸ë£¹ í¬ê¸°: {len(enemies)}")
        else:
            # ê³ ì–‘ì´ ìŠ¤í°ì´ ë©ˆì¶˜ ì´ìœ  ë¡œê¹…
            if cats_spawned >= total_cats:
                print(f"ğŸ± ê³ ì–‘ì´ ìŠ¤í° ì™„ë£Œ: {cats_spawned}/{total_cats}")
            if boss_spawned:
                print(f"ğŸ± ë³´ìŠ¤ ìŠ¤í°ë¨ - ê³ ì–‘ì´ ìŠ¤í° ì¤‘ë‹¨")
            if len(enemies) > 0:
                print(f"ğŸ± í˜„ì¬ enemies ê·¸ë£¹ í¬ê¸°: {len(enemies)}")

        # ê°„ì‹ ìŠ¤í° ë¡œì§ (í•œ ë²ˆë§Œ)
        if not hasattr(reset_game, 'snack_spawned') or not reset_game.snack_spawned:
            snack_spawn_timer += dt
            if snack_spawn_timer > config.SNACK_SPAWN_INTERVAL:
                snack_spawn_timer = 0
                snack = Snack(config.WIDTH + 30, config.HEIGHT - 80)
                items.add(snack)
                all_sprites.add(snack)
                reset_game.snack_spawned = True

        # ê°•ì•„ì§€ ìŠ¤í° ë¡œì§ (ëœë¤ ê°„ê²©ìœ¼ë¡œ ìŠ¤í°)
        # next_puppy_intervalì´ ì •ì˜ë˜ì§€ ì•Šì•˜ì„ ë•Œ ê¸°ë³¸ê°’ ì„¤ì •
        if not hasattr(reset_game, 'next_puppy_interval'):
            reset_game.next_puppy_interval = random.randint(config.PUPPY_SPAWN_MIN_INTERVAL, config.PUPPY_SPAWN_MAX_INTERVAL)
            print(f"ğŸ• next_puppy_interval ì´ˆê¸°í™”: {reset_game.next_puppy_interval}ms")
        
        puppy_spawn_timer += dt
        # ë§¤ 1000msë§ˆë‹¤ë§Œ ë¡œê·¸ ì¶œë ¥ (ë„ˆë¬´ ë§ì´ ì¶œë ¥ë˜ì§€ ì•Šë„ë¡)
        if puppy_spawn_timer % 1000 < dt:
            print(f"ğŸ• puppy_spawn_timer: {puppy_spawn_timer}ms, next_interval: {reset_game.next_puppy_interval}ms")
        if puppy_spawn_timer > reset_game.next_puppy_interval:
            puppy_spawn_timer = 0
            puppy = Puppy(config.WIDTH + 30, config.HEIGHT - 80)
            puppies.add(puppy)
            all_sprites.add(puppy)
            print(f"ğŸ• puppy ìŠ¤í°ë¨ (ìœ„ì¹˜: {puppy.rect.x}, {puppy.rect.y}, ì´ë¯¸ì§€: ì¢Œìš° ë°˜ì „)")
            print(f"ğŸ• í˜„ì¬ puppies ê·¸ë£¹ í¬ê¸°: {len(puppies)}")
            reset_game.next_puppy_interval = random.randint(config.PUPPY_SPAWN_MIN_INTERVAL, config.PUPPY_SPAWN_MAX_INTERVAL) # ë‹¤ìŒ puppy ìŠ¤í° ê°„ê²© ì—…ë°ì´íŠ¸
            print(f"ğŸ• ë‹¤ìŒ puppy ìŠ¤í° ê°„ê²©: {reset_game.next_puppy_interval}ms")

        # ëª¨ë“  ê³ ì–‘ì´ë¥¼ ì²˜ì¹˜í–ˆì„ ë•Œ ë³´ìŠ¤ ìŠ¤í°
        if cats_spawned >= total_cats and not boss_spawned and len(enemies) == 0:
            boss = BossCat(config.WIDTH - 150, config.HEIGHT - 50, current_stage)
            enemies.add(boss)
            all_sprites.add(boss)
            boss_spawned = True

        for shuriken in shurikens:
            if len(enemies) > 0:
                hit_cats = pygame.sprite.spritecollide(shuriken, enemies, False)
            else:
                hit_cats = []
            for cat in hit_cats:
                if isinstance(cat, BossCat):
                    cat.hp -= 1
                    if cat.hp <= 0:
                        cat.kill()
                        score += config.SCORE_BOSS
                        # ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì§„í–‰ (ì»¤ìŠ¤í…€ ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì—°ì¶œ)
                        if current_stage < config.MAX_STAGE:
                            game_state = "stage_clear"
                            stage_clear_start_time = pygame.time.get_ticks()
                            stage_clear_jump_index = -1
                            # í”Œë ˆì´ì–´ë¥¼ í™”ë©´ ì¤‘ì•™ìœ¼ë¡œ ì´ë™í•˜ê³  ë°”ë‹¥ì— ì •ë ¬
                            player.rect.centerx = config.WIDTH // 2
                            player.rect.bottom = config.HEIGHT - 50
                            player.vel_y = 0
                            player.on_ground = True
                            # ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì‹œ í‘œì°½(ìˆ˜ë¦¬ê²€), ëŒ ì¦‰ì‹œ ì œê±°
                            for s in list(shurikens):
                                s.kill()
                            for st in list(stones):
                                st.kill()
                        else:
                            # ëª¨ë“  ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´
                            game_state = "game_clear"
                    shuriken.kill()
                else:
                    cat.hp -= 1
                    if cat.hp <= 0:
                        if hasattr(cat, "color_name"):
                            score += config.SCORE_PER_CAT.get(cat.color_name, 0)
                        cat.kill()
                    shuriken.kill()

        # ì¶©ëŒ ì²´í¬ ë¶€ë¶„(playing ìƒíƒœ)
        # player_touch_rect = get_touch_rect(player, config.PLAYER_TOUCH_MARGIN)
        if len(items) > 0:
            hit_snack = pygame.sprite.spritecollide(player, items, True)
        else:
            hit_snack = []
        if hit_snack:
            player.eat_snack()

        # ê°•ì•„ì§€ ì¶©ëŒ ê°ì§€
        if len(puppies) > 0:
            hit_puppy = pygame.sprite.spritecollide(player, puppies, True)
        else:
            hit_puppy = []
        if hit_puppy:
            print(f"ğŸ• puppy ì¶©ëŒ ê°ì§€! hit_puppy ê°œìˆ˜: {len(hit_puppy)}")
            if player.get_puppy():
                # puppy íšë“ ì„±ê³µ
                print(f"ğŸ• puppy íšë“ ì„±ê³µ! (í”Œë ˆì´ì–´ì™€ í•¨ê»˜ í‘œì‹œ: ì›ë˜ ì´ë¯¸ì§€)")
            else:
                # ì´ë¯¸ puppyë¥¼ ê°€ì§€ê³  ìˆìŒ - hit_puppyë¥¼ ë‹¤ì‹œ ì¶”ê°€
                print(f"ğŸ• ì´ë¯¸ puppy ë³´ìœ  ì¤‘ - puppy ë°˜í™˜")
                for puppy in hit_puppy:
                    puppies.add(puppy)
                    all_sprites.add(puppy)

        # ì ê³¼ì˜ ì¶©ëŒ ì‹œ ë°©ì–´ íš¨ê³¼ ì ìš©
        if len(enemies) > 0:
            enemy_touched = False
            touched_enemy = None
            # puppyê°€ ìˆìœ¼ë©´ ì •ìƒ ì¶©ëŒ ì˜ì—­, ì—†ìœ¼ë©´ ì‘ì€ ì¶©ëŒ ì˜ì—­ ì‚¬ìš©
            if player.has_defense():
                collision_rect = player.rect
                print(f"ğŸ• puppy ìˆìŒ - ì •ìƒ ì¶©ëŒ ì˜ì—­ ì‚¬ìš©")
            else:
                # puppyê°€ ì—†ì„ ë•ŒëŠ” ë” ì‘ì€ ì¶©ëŒ ì˜ì—­ ì‚¬ìš©
                collision_rect = get_touch_rect(player, config.PUPPY_LESS_COLLISION_MARGIN)  # configì—ì„œ ì„¤ì •ëœ ì—¬ë°±
                print(f"âŒ puppy ì—†ìŒ - ì‘ì€ ì¶©ëŒ ì˜ì—­ ì‚¬ìš© (ì—¬ìœ : {config.PUPPY_LESS_COLLISION_MARGIN}í”½ì…€)")
            
            for enemy in enemies:
                if collision_rect.colliderect(enemy.rect):
                    enemy_touched = True
                    touched_enemy = enemy
                    break
            if enemy_touched:
                if player.has_defense():
                    # puppyê°€ ìˆìœ¼ë©´ ë°©ì–´ íš¨ê³¼ ì ìš©
                    print(f"ğŸ• ë°©ì–´ íš¨ê³¼ ì ìš©! í˜„ì¬ ë°©ì–´ íšŸìˆ˜: {player.defense_count}")
                    # ì¶©ëŒí•œ ì  ì œê±° + ì ìˆ˜ ë°˜ì˜
                    if touched_enemy:
                        if isinstance(touched_enemy, BossCat):
                            # ë³´ìŠ¤ ì œê±° ì‹œ ì ìˆ˜ ë° ìŠ¤í…Œì´ì§€ ì§„í–‰
                            score += config.SCORE_BOSS
                            touched_enemy.kill()
                            if current_stage < config.MAX_STAGE:
                                # ë³´ìŠ¤ì™€ ì¶©ëŒë¡œ ë³´ìŠ¤ë¥¼ ì œê±°í•œ ê²½ìš°ì—ë„ ë™ì¼í•œ ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì—°ì¶œë¡œ ì´ë™
                                game_state = "stage_clear"
                                stage_clear_start_time = pygame.time.get_ticks()
                                stage_clear_jump_index = -1
                                player.rect.centerx = config.WIDTH // 2
                                player.rect.bottom = config.HEIGHT - 50
                                player.vel_y = 0
                                player.on_ground = True
                                # ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì‹œ í‘œì°½(ìˆ˜ë¦¬ê²€), ëŒ ì¦‰ì‹œ ì œê±°
                                for s in list(shurikens):
                                    s.kill()
                                for st in list(stones):
                                    st.kill()
                            else:
                                game_state = "game_clear"
                        else:
                            if hasattr(touched_enemy, "color_name"):
                                score += config.SCORE_PER_CAT.get(touched_enemy.color_name, 0)
                            touched_enemy.kill()
                        print(f"ğŸ• ë°©ì–´ íš¨ê³¼ë¡œ ì  ì œê±°ë¨")
                    # puppy ë°©ì–´ íš¨ê³¼ 1íšŒ ì†Œëª¨
                    player.remove_puppy_defense()
                    # ë°©ì–´ ì„±ê³µ - ê²Œì„ ì˜¤ë²„ë˜ì§€ ì•ŠìŒ
                else:
                    # puppyê°€ ì—†ìœ¼ë©´ ê²Œì„ ì˜¤ë²„
                    print("âŒ ë°©ì–´ íš¨ê³¼ ì—†ìŒ - ê²Œì„ ì˜¤ë²„")
                    player.alive = False
                    elapsed_seconds = (pygame.time.get_ticks() - game_start_ticks) / 1000.0
                    if is_top10_score(score, elapsed_seconds, highscores_cache):
                        entered_name = ""
                        game_state = "name_entry"
                    else:
                        game_state = "game_over"

        # ëŒ ì¶©ëŒë„ ë™ì¼í•˜ê²Œ
        stone_touched = False
        touched_stone = None
        # puppyê°€ ìˆìœ¼ë©´ ì •ìƒ ì¶©ëŒ ì˜ì—­, ì—†ìœ¼ë©´ ì‘ì€ ì¶©ëŒ ì˜ì—­ ì‚¬ìš©
        if player.has_defense():
            collision_rect = player.rect
            print(f"ğŸª¨ puppy ìˆìŒ - ì •ìƒ ì¶©ëŒ ì˜ì—­ ì‚¬ìš©")
        else:
            # puppyê°€ ì—†ì„ ë•ŒëŠ” ë” ì‘ì€ ì¶©ëŒ ì˜ì—­ ì‚¬ìš©
            collision_rect = get_touch_rect(player, config.PUPPY_LESS_COLLISION_MARGIN)  # configì—ì„œ ì„¤ì •ëœ ì—¬ë°±
            print(f"ğŸª¨ puppy ì—†ìŒ - ì‘ì€ ì¶©ëŒ ì˜ì—­ ì‚¬ìš© (ì—¬ìœ : {config.PUPPY_LESS_COLLISION_MARGIN}í”½ì…€)")
        
        for stone in stones:
            if collision_rect.colliderect(stone.rect):
                stone_touched = True
                touched_stone = stone
                break
        if stone_touched:
            if player.has_defense():
                # puppyê°€ ìˆìœ¼ë©´ ë°©ì–´ íš¨ê³¼ ì ìš©
                print(f"ğŸª¨ ëŒ ì¶©ëŒ ë°©ì–´ íš¨ê³¼ ì ìš©! í˜„ì¬ ë°©ì–´ íšŸìˆ˜: {player.defense_count}")
                # ì¶©ëŒí•œ stone ì œê±°
                if touched_stone:
                    touched_stone.kill()
                    print(f"ğŸª¨ ë°©ì–´ íš¨ê³¼ë¡œ stone ì œê±°ë¨")
                # puppy ë°©ì–´ íš¨ê³¼ 1íšŒ ì†Œëª¨
                player.remove_puppy_defense()
                # ë°©ì–´ ì„±ê³µ - ê²Œì„ ì˜¤ë²„ë˜ì§€ ì•ŠìŒ
            else:
                # puppyê°€ ì—†ìœ¼ë©´ ê²Œì„ ì˜¤ë²„
                print("ğŸª¨ ëŒ ì¶©ëŒ ë°©ì–´ íš¨ê³¼ ì—†ìŒ - ê²Œì„ ì˜¤ë²„")
                player.alive = False
                elapsed_seconds = (pygame.time.get_ticks() - game_start_ticks) / 1000.0
                if is_top10_score(score, elapsed_seconds, highscores_cache):
                    entered_name = ""
                    game_state = "name_entry"
                else:
                    game_state = "game_over"

        # ê²Œì„ í™”ë©´ ê·¸ë¦¬ê¸°
        screen.fill(config.BACKGROUND_COLOR)
        draw_background_elements() # ë°°ê²½ ìš”ì†Œ ê·¸ë¦¬ê¸°
        draw_clouds()  # êµ¬ë¦„ ê·¸ë¦¬ê¸°
        pygame.draw.rect(screen, config.GROUND_COLOR, (0, config.HEIGHT-50, config.WIDTH, 50))
        all_sprites.draw(screen)
        
        # í”Œë ˆì´ì–´ì™€ í•¨ê»˜ puppy í‘œì‹œ
        player.draw_puppy(screen)

        # UI ì •ë³´ í‘œì‹œ
        # í˜„ì¬ ìŠ¤í…Œì´ì§€ í‘œì‹œ
        draw_text(f"ìŠ¤í…Œì´ì§€ {current_stage}", 10, 10, config.WHITE, font_large)
        # ì¤‘ì•™ ìƒë‹¨ ì ìˆ˜/ì‹œê°„
        elapsed_seconds = (pygame.time.get_ticks() - game_start_ticks) // 1000
        info_text = f"ì ìˆ˜: {score} | ì‹œê°„: {int(elapsed_seconds)}ì´ˆ"
        info_img = font_small.render(info_text, True, config.WHITE)
        info_x = (config.WIDTH - info_img.get_width()) // 2
        screen.blit(info_img, (info_x, 10))
        
        # ìŠ¤í…Œì´ì§€ ì‹œì‘ ë©”ì‹œì§€ í‘œì‹œ (3ì´ˆê°„)
        if pygame.time.get_ticks() - stage_start_time < 3000:
            stage_message = f"Stage {current_stage} ì‹œì‘!"
            draw_centered_text(stage_message, 150, config.YELLOW, font_large)
        
        if player.shuriken_double:
            time_left = (player.double_end_time - pygame.time.get_ticks()) // 1000
            # draw_text(f"ê°„ì‹ íš¨ê³¼: {time_left}ì´ˆ", 10, 70, config.BLUE)
        
        # ë°©ì–´ íšŸìˆ˜ í‘œì‹œ
        # if player.defense_count > 0:
        #     draw_text(f"ë°©ì–´ íš¨ê³¼: í™œì„±í™” ({player.defense_count}íšŒ)", 10, 100, config.YELLOW)
        # else:
        #     draw_text("ë°©ì–´ íš¨ê³¼: ë¹„í™œì„±í™”", 10, 100, config.GRAY)
        
        # ë‚¨ì€ ê³ ì–‘ì´ ìˆ˜ í‘œì‹œ
        if not boss_spawned:
            remaining_cats = total_cats - cats_spawned + len([e for e in enemies if not isinstance(e, BossCat)])
            # draw_text(f"ë‚¨ì€ ê³ ì–‘ì´: {remaining_cats}ë§ˆë¦¬", 10, 50, config.WHITE)
            # ë””ë²„ê¹… ì •ë³´ ì¶”ê°€
            # draw_text(f"ìŠ¤í°ëœ ê³ ì–‘ì´: {cats_spawned}/{total_cats}", 10, 130, config.WHITE, font_small)
            # draw_text(f"í˜„ì¬ enemies: {len(enemies)}", 10, 150, config.WHITE, font_small)
        else:
            # ë³´ìŠ¤ ì²´ë ¥ í‘œì‹œ
            boss = None
            for enemy in enemies:
                if isinstance(enemy, BossCat):
                    boss = enemy
                    break
            
            if boss:
                # ë³´ìŠ¤ HPë¥¼ ì˜¤ë¥¸ìª½ ìƒë‹¨ì— í‘œì‹œ
                draw_text("ë³´ìŠ¤ ê³ ì–‘ì´ ì¶œí˜„!", config.WIDTH - 200, 10, config.RED, font_large)
                
                # ë³´ìŠ¤ ì²´ë ¥ ë°” í‘œì‹œ (ì˜¤ë¥¸ìª½ ìƒë‹¨)
                health_bar_width = config.BOSS_HP_BAR_WIDTH
                health_bar_height = config.BOSS_HP_BAR_HEIGHT
                health_ratio = boss.hp / (config.BASE_BOSS_HP * (2 ** (current_stage - 1)))
                health_bar_x = config.WIDTH - health_bar_width - config.BOSS_HP_BAR_MARGIN  # ì˜¤ë¥¸ìª½ì—ì„œ ì—¬ë°±
                health_bar_y = 50
                
                # ë°°ê²½ ì²´ë ¥ ë°”
                pygame.draw.rect(screen, (100, 100, 100), (health_bar_x, health_bar_y, health_bar_width, health_bar_height))
                # í˜„ì¬ ì²´ë ¥ ë°”
                current_health_width = int(health_bar_width * health_ratio)
                health_color = (255, 0, 0) if health_ratio > 0.5 else (255, 255, 0) if health_ratio > 0.2 else (255, 0, 0)
                pygame.draw.rect(screen, health_color, (health_bar_x, health_bar_y, current_health_width, health_bar_height))
                # ì²´ë ¥ ë°” í…Œë‘ë¦¬
                pygame.draw.rect(screen, config.WHITE, (health_bar_x, health_bar_y, health_bar_width, health_bar_height), 2)
                
                # ì²´ë ¥ ìˆ˜ì¹˜ í‘œì‹œ (ì˜¤ë¥¸ìª½ ìƒë‹¨)
                max_boss_hp = config.BASE_BOSS_HP * (2 ** (current_stage - 1))
                draw_text(f"ë³´ìŠ¤ ì²´ë ¥: {boss.hp}/{max_boss_hp}", config.WIDTH - config.BOSS_HP_BAR_WIDTH - config.BOSS_HP_BAR_MARGIN, 80, config.WHITE)

        pygame.display.flip()
    
    elif game_state == "game_over":
        # ê²Œì„ ì§„í–‰ ì¤‘ì˜ ë°°ê²½ê³¼ ìŠ¤í”„ë¼ì´íŠ¸ë“¤ì„ ë¨¼ì € ê·¸ë¦¬ê¸°
        screen.fill(config.BACKGROUND_COLOR)
        draw_clouds()  # êµ¬ë¦„ ê·¸ë¦¬ê¸°
        draw_background_elements()  # ì‚°ê³¼ ë‚˜ë¬´ ê·¸ë¦¬ê¸°
        pygame.draw.rect(screen, config.GROUND_COLOR, (0, config.HEIGHT-50, config.WIDTH, 50))
        
        # ëª¨ë“  ìŠ¤í”„ë¼ì´íŠ¸ ê·¸ë¦¬ê¸° (ê³ ì–‘ì´, ë³´ìŠ¤, ëŒ, ê°„ì‹, puppy ë“±)
        all_sprites.draw(screen)
        
        # í”Œë ˆì´ì–´ì™€ í•¨ê»˜ puppy í‘œì‹œ
        player.draw_puppy(screen)
        
        # ë°˜íˆ¬ëª… ì˜¤ë²„ë ˆì´ (ê²Œì„ ì˜¤ë²„ í…ìŠ¤íŠ¸ë¥¼ ìœ„í•œ ë°°ê²½)
        overlay = pygame.Surface((config.WIDTH, config.HEIGHT))
        overlay.set_alpha(128)
        overlay.fill((0, 0, 0))
        screen.blit(overlay, (0, 0))
        
        # ê²Œì„ ì˜¤ë²„ í…ìŠ¤íŠ¸ë“¤
        draw_centered_text("ê²Œì„ ì˜¤ë²„!", config.HEIGHT//2 - 120, config.RED, font_large)
        total_elapsed = (pygame.time.get_ticks() - game_start_ticks) // 1000
        draw_centered_text(f"ìµœì¢… ì ìˆ˜: {score}ì  | ì‹œê°„: {int(total_elapsed)}ì´ˆ", config.HEIGHT//2 - 80, config.YELLOW, font)

        # TOP 10 í‘œì‹œ
        highs = load_highscores()
        draw_centered_text("TOP 10", config.HEIGHT//2 - 40, config.GREEN, font)
        y = config.HEIGHT//2 - 10
        if highs:
            for idx, rec in enumerate(highs, start=1):
                name = str(rec.get("name", "???"))[:config.PLAYER_NAME_MAX_LENGTH]
                s_val = int(rec.get("score", 0))
                t_val = int(float(rec.get("time", 0)))
                draw_centered_text(f"{idx}. {name} - {s_val}ì  ({t_val}ì´ˆ)", y, config.WHITE, font_small)
                y += 20
        else:
            draw_centered_text("ê¸°ë¡ ì—†ìŒ", y, config.GRAY, font_small)
            y += 20

        draw_centered_text("ìŠ¤í˜ì´ìŠ¤ë°”: ì¬ì‹œì‘", y + 10, config.WHITE, font)
        draw_centered_text("M í‚¤: ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°", y + 40, config.WHITE, font)
        
        pygame.display.flip()
    
    elif game_state == "stage_clear":
        # ìƒˆë¡œìš´ ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì—°ì¶œ: í”Œë ˆì´ì–´ ì¤‘ì•™ ì •ë ¬ + ì í”„ 3íšŒ + 3ì´ˆ ëŒ€ê¸° í›„ ë‹¤ìŒ ìŠ¤í…Œì´ì§€
        elapsed_time = pygame.time.get_ticks() - stage_clear_start_time

        # í•­ìƒ ì¤‘ì•™ì— ê³ ì •í•˜ê³  ë°”ë‹¥ì— ë¶™ì—¬ë‘  (ìˆ˜í‰ì€ ê³ ì •, ìˆ˜ì§ì€ ì í”„ ì‹œì—ë§Œ ë³€ê²½)
        player.rect.centerx = config.WIDTH // 2
        if player.rect.bottom > config.HEIGHT - 50:
            player.rect.bottom = config.HEIGHT - 50

        # 3ì´ˆ ë™ì•ˆ 3ë²ˆ ì í”„ (ê° 1ì´ˆë§ˆë‹¤ í•œë²ˆ íŠ¸ë¦¬ê±°)
        # ì í”„ íŠ¸ë¦¬ê±° íƒ€ì´ë°: 0ms, 1000ms, 2000ms ê·¼ì²˜ì—ì„œ í•œ ë²ˆë§Œ ì‹¤í–‰
        intended_index = min(elapsed_time // 1000, 2)  # 0,1,2 ì¤‘ í•˜ë‚˜
        if intended_index != stage_clear_jump_index and intended_index <= 2:
            stage_clear_jump_index = intended_index
            player.vel_y = config.PLAYER_JUMP_VELOCITY
            player.on_ground = False

        # ì¤‘ë ¥ ì ìš© ë° ì°©ì§€ ì²˜ë¦¬
        player.vel_y += config.GRAVITY
        player.rect.y += player.vel_y
        if player.rect.bottom >= config.HEIGHT - 50:
            player.rect.bottom = config.HEIGHT - 50
            player.vel_y = 0
            player.on_ground = True

        # 3ì´ˆ ê²½ê³¼ ì‹œ ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì „í™˜
        if elapsed_time >= 3000:
            current_stage += 1
            stage_start_time = pygame.time.get_ticks()
            # ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ì¤€ë¹„
            cats_spawned = 0
            boss_spawned = False
            spawn_timer = 0
            snack_spawn_timer = 0
            puppy_spawn_timer = 0
            reset_game.next_puppy_interval = random.randint(config.PUPPY_SPAWN_MIN_INTERVAL, config.PUPPY_SPAWN_MAX_INTERVAL)
            reset_game.snack_spawned = False
            for group in [enemies, shurikens, items, puppies, stones]:
                group.empty()
            all_sprites.empty()
            all_sprites.add(player)
            game_state = "playing"

        # í™”ë©´ ê·¸ë¦¬ê¸°
        screen.fill(config.BACKGROUND_COLOR)
        draw_background_elements()
        draw_clouds()
        pygame.draw.rect(screen, config.GROUND_COLOR, (0, config.HEIGHT-50, config.WIDTH, 50))
        all_sprites.draw(screen)
        player.draw_puppy(screen)

        # ìƒë‹¨ ì¤‘ì•™ VICTORY ë°°ë„ˆ
        draw_centered_text("VICTORY", 20, config.YELLOW, font_large)

        # ê°„ë‹¨ ë©”ì‹œì§€ ë° ë‚¨ì€ ì‹œê°„
        draw_centered_text(f"ìŠ¤í…Œì´ì§€ {current_stage} í´ë¦¬ì–´!", config.HEIGHT//2 - 80, config.YELLOW, font_large)
        draw_centered_text("ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ì¤€ë¹„ ì¤‘...", config.HEIGHT//2 - 40, config.GREEN, font)
        remaining_time = max(0, 3 - (elapsed_time // 1000))
        draw_centered_text(f"{remaining_time}ì´ˆ í›„ ë‹¤ìŒ ìŠ¤í…Œì´ì§€", config.HEIGHT//2, config.WHITE, font)

        pygame.display.flip()
    
    elif game_state == "game_clear":
        # ê²Œì„ ì§„í–‰ ì¤‘ì˜ ë°°ê²½ê³¼ ìŠ¤í”„ë¼ì´íŠ¸ë“¤ì„ ë¨¼ì € ê·¸ë¦¬ê¸°
        screen.fill(config.BACKGROUND_COLOR)
        draw_clouds()  # êµ¬ë¦„ ê·¸ë¦¬ê¸°
        draw_background_elements()  # ì‚°ê³¼ ë‚˜ë¬´ ê·¸ë¦¬ê¸°
        pygame.draw.rect(screen, config.GROUND_COLOR, (0, config.HEIGHT-50, config.WIDTH, 50))
        
        # ëª¨ë“  ìŠ¤í”„ë¼ì´íŠ¸ ê·¸ë¦¬ê¸° (ê³ ì–‘ì´, ë³´ìŠ¤, ëŒ, ê°„ì‹, puppy ë“±)
        all_sprites.draw(screen)
        
        # í”Œë ˆì´ì–´ì™€ í•¨ê»˜ puppy í‘œì‹œ
        player.draw_puppy(screen)
        
        # ë°˜íˆ¬ëª… ì˜¤ë²„ë ˆì´ (ê²Œì„ í´ë¦¬ì–´ í…ìŠ¤íŠ¸ë¥¼ ìœ„í•œ ë°°ê²½)
        overlay = pygame.Surface((config.WIDTH, config.HEIGHT))
        overlay.set_alpha(128)
        overlay.fill((0, 0, 0))
        screen.blit(overlay, (0, 0))
        
        # ê²Œì„ í´ë¦¬ì–´ í…ìŠ¤íŠ¸ë“¤
        if current_stage >= config.MAX_STAGE:
            draw_centered_text("ê²Œì„ í´ë¦¬ì–´!", config.HEIGHT//2 - 60, config.BLUE, font_large)
            draw_centered_text("ëª¨ë“  ìŠ¤í…Œì´ì§€ ì™„ì£¼!", config.HEIGHT//2 - 20, config.GREEN, font)
        else:
            draw_centered_text("ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´!", config.HEIGHT//2 - 60, config.BLUE, font_large)
            draw_centered_text(f"ìŠ¤í…Œì´ì§€ {current_stage} ì™„ì£¼!", config.HEIGHT//2 - 20, config.GREEN, font)
        draw_centered_text("ìŠ¤í˜ì´ìŠ¤ë°”: ì¬ì‹œì‘", config.HEIGHT//2 + 20, config.WHITE, font)
        draw_centered_text("M í‚¤: ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°", config.HEIGHT//2 + 50, config.WHITE, font)
        
        pygame.display.flip()

    elif game_state == "name_entry":
        # ì´ë¦„ ì…ë ¥ í™”ë©´
        screen.fill(config.BACKGROUND_COLOR)
        draw_clouds()
        draw_background_elements()
        pygame.draw.rect(screen, config.GROUND_COLOR, (0, config.HEIGHT-50, config.WIDTH, 50))

        overlay = pygame.Surface((config.WIDTH, config.HEIGHT))
        overlay.set_alpha(160)
        overlay.fill((0, 0, 0))
        screen.blit(overlay, (0, 0))

        draw_centered_text("ì‹ ê¸°ë¡! ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", config.HEIGHT//2 - 80, config.YELLOW, font_large)
        draw_centered_text(f"ìµœì¢… ì ìˆ˜: {score}ì ", config.HEIGHT//2 - 40, config.WHITE, font)
        elapsed_disp = (pygame.time.get_ticks() - game_start_ticks) // 1000
        draw_centered_text(f"ì‹œê°„: {int(elapsed_disp)}ì´ˆ", config.HEIGHT//2 - 10, config.WHITE, font)

        name_display = entered_name if (pygame.time.get_ticks() // 500) % 2 == 0 else entered_name + "_"
        draw_centered_text(f"ì´ë¦„: {name_display}", config.HEIGHT//2 + 30, config.GREEN, font)
        draw_centered_text("Enter: ì €ì¥, Backspace: ì§€ìš°ê¸°", config.HEIGHT//2 + 70, config.GRAY, font_small)

        pygame.display.flip()

pygame.quit()
